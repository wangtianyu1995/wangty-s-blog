

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="zh-CN" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="zh-CN" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>技术 &mdash; wangty 1.0 文档</title>
  

  
  
  
  

  

  
  
    

  

  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />
    <link rel="index" title="索引" href="../genindex.html" />
    <link rel="search" title="搜索" href="../search.html" />
    <link rel="next" title="产品" href="product.html" />
    <link rel="prev" title="思考" href="think.html" /> 

  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../index.html" class="icon icon-home"> wangty
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">目录:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="think.html">思考</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">技术</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#python">python的设计哲学</a></li>
<li class="toctree-l2"><a class="reference internal" href="#id2">python基本知识</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#pypi">pypi上传模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#pylint">pylint</a></li>
<li class="toctree-l3"><a class="reference internal" href="#for-else">for - else</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id3">一颗星()和两颗星(*)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id4">三元表达式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#with-as">with - as</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id5">列表推导式</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id6">列表索引的各种操作</a></li>
<li class="toctree-l3"><a class="reference internal" href="#lambda">lambda函数</a></li>
<li class="toctree-l3"><a class="reference internal" href="#yield">yield 以及生成器和迭代器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id7">装饰器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#assert">断言assert</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id8">算法</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id9">算法的重要性</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id10">机器学习算法</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id11">监督学习</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id12">无监督学习</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id13">单变量线性回归</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id14">梯度下降算法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id15">线性回归的梯度下降</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id16">矩阵和向量</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id17">多变量线性回归</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id18">多元梯度下降</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id19">特征缩放</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id20">学习率</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id21">特征与多项式回归</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id22">正规方程</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id23">正规方程法与梯度下降法的比较</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#octave">octave</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id24">基础概率知识</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id25">协方差</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id26">标准差（均方差）</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id27">方差</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id28">利用方差减少网络延时误差</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#django">Django</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id29">Django目录结构</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id30">Django创建启动默认服务器</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id31">Django模版渲染语言</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django-1-projectapp-runserver">Django 源码学习（1）——建立project和app，及runserver</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django-2-url">Django 源码学习（2）——url路由</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django-3">Django 源码学习（3）——中间件</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django-4-views">Django 源码学习（4）—— Views模块</a></li>
<li class="toctree-l3"><a class="reference internal" href="#django-400">启动Django 400错误可能的原因</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id32">模版渲染语言，从字典中取值</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#flask">Flask</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#flask-demo">Flask Demo</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id33">Flask 框架知识点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id34">1.路由</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id35">2.重定向</a></li>
<li class="toctree-l4"><a class="reference internal" href="#url">3.构造 URL</a></li>
<li class="toctree-l4"><a class="reference internal" href="#http">4.HTTP 方法</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id36">5.静态文件</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id37">6.模板渲染</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id38">7.访问请求数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id39">8.获取表单数据</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id40">9.会话</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id41">10.蓝图划分</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#flaskjson">Flask设置返回json格式数据</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id42">Flask源码解读(一) 启动流程</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id43">Flask源码解读(二) 路由原理</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id44">Flask源码解读(三) 模版渲染过程</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id45">测试</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id46">单元测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#unittest">单元测试框架—unittest</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#id47">压力测试</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#ab">ab压力测试工具</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id48">压力测试指标</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#id49">前端</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#h5">h5基础知识</a></li>
<li class="toctree-l3"><a class="reference internal" href="#css">css基础知识</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id50">css的三种样式</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id51">css选择器分类</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id52">css伪类</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id53">css伪元素</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id54">css选择器的优先级别</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id55">修改标签的显示类型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id56">css属性</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id57">css盒子模型</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id58">css新增特性</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id59">css布局</a></li>
<li class="toctree-l4"><a class="reference internal" href="#id60">标签的居中</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#js">js打乱数组</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id61">微信小程序</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#id62">用户转发</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#nginx">Nginx</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#id63">Nginx简介</a></li>
<li class="toctree-l3"><a class="reference internal" href="#id64">Nginx知识点</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#location">location优先级</a></li>
<li class="toctree-l4"><a class="reference internal" href="#upstream">upstream负载均衡</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#gzip">GZIP调优</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#nginxgzip">Nginx的gzip配置</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#uwsgi">Uwsgi</a></li>
<li class="toctree-l2"><a class="reference internal" href="#supervisor">Supervisor</a></li>
<li class="toctree-l2"><a class="reference internal" href="#code-mirror">Code Mirror代码编辑器插件</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="product.html">产品</a></li>
<li class="toctree-l1"><a class="reference internal" href="management.html">管理</a></li>
<li class="toctree-l1"><a class="reference internal" href="industry.html">行业</a></li>
<li class="toctree-l1"><a class="reference internal" href="about.html">关于</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">wangty</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html">Docs</a> &raquo;</li>
        
      <li>技术</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="../_sources/myclass/technology.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="id1">
<h1>技术<a class="headerlink" href="#id1" title="永久链接至标题">¶</a></h1>
<div class="section" id="python">
<h2>python的设计哲学<a class="headerlink" href="#python" title="永久链接至标题">¶</a></h2>
<p>在 python shell 中输入：import this</p>
<blockquote>
<div><div class="highlight-default notranslate"><div class="highlight"><pre><span></span>The Zen of Python, by Tim Peters
Python 的设计哲学，作者：Tim Peters

Beautiful is better than ugly.
优雅胜于丑陋。

Explicit is better than implicit.
明确胜于含糊。

Simple is better than complex.
简单胜于复杂。

Complex is better than complicated.
复杂胜于繁琐。

Flat is better than nested.
扁平胜于嵌套。

Sparse is better than dense.
间隔胜于紧凑。

Readability counts.
可读性很重要。

Special cases aren&#39;t special enough to break the rules.
即使假借特殊之名，也不应打破这些原则。

Although practicality beats purity.
尽管实践大于理论。

Errors should never pass silently.
错误不可置之不理。

Unless explicitly silenced.
除非另有明确要求。

In the face of ambiguity, refuse the temptation to guess.
面对模棱两可，拒绝猜测。

There should be one-- and preferably only one --obvious way to do it.
用一种方法，最好是只有一种方法来做一件事。

Although that way may not be obvious at first unless you&#39;re Dutch.
虽然这种方式开始时并不容易，除非你是 Python 之父。

Now is better than never.
但从现在就开始这么做，总比永远都不做好。

Although never is often better than *right* now.
尽管经常有时 “没有做” 反倒比 “现在立马做“ 结果要好。

If the implementation is hard to explain, it&#39;s a bad idea.
如果一个实现不容易解释，那么它肯定是个坏主意。

If the implementation is easy to explain, it may be a good idea.
如果一个实现很容易解释，那么它也许是个好主意。

Namespaces are one honking great idea -- let&#39;s do more of those!
就像命名空间就是一个绝妙的想法，应当多加利用。
</pre></div>
</div>
</div></blockquote>
</div>
<div class="section" id="id2">
<h2>python基本知识<a class="headerlink" href="#id2" title="永久链接至标题">¶</a></h2>
<div class="section" id="pypi">
<h3>pypi上传模块<a class="headerlink" href="#pypi" title="永久链接至标题">¶</a></h3>
<p>第一步：注册一个账号 <a class="reference external" href="https://pypi.python.org/pypi">https://pypi.python.org/pypi</a>
你想让你的轮子让所有人都能下载，首先得先把轮子共享出去，不然别人访问不到，我们需要注册一个pypi的账号（轮子集中营）</p>
<p>第二步：在你轮子的目录下创建一个setup.py文件，文件内容如下</p>
<dl>
<dt>::</dt><dd><p>from distutils.core import setup</p>
<dl class="simple">
<dt>setup(</dt><dd><p>name = ‘下载的模块名’,
version = ‘1.1.0’,
py_modules = [‘你写好的模块名称’],
author = ‘wangty’,
author_email = <a class="reference external" href="mailto:'xxxxxxxxxx&#37;&#52;&#48;qq&#46;com">‘xxxxxxxxxx<span>&#64;</span>qq<span>&#46;</span>com</a>’,
url = ‘… ‘,
description = ‘…’
)</p>
</dd>
</dl>
</dd>
</dl>
<p>第三步：python setup.py sdist</p>
<p>第四步：python setup.py install</p>
<p>第五步：安装twine pip install twine</p>
<p>第六步：上传模块文件：twine upload dist/* 这个时候你登录的pypi账号就可以看到了</p>
<p>第七步：创建一个空文件，import 你的模块名 （import shengdanshu） 轮子完毕</p>
</div>
<div class="section" id="pylint">
<h3>pylint<a class="headerlink" href="#pylint" title="永久链接至标题">¶</a></h3>
<p>PyLint 是 Python 源代码分析器，可以分析 Python 代码中的错误，查找不符合代码风格标准和有潜在问题的代码，是一个可以用于验证多个文件的模块和包的工具。
缺省情况下，PyLint 启用许多规则。它具有高度可配置性，从代码内部处理程序控制它。另外，编写插件添加到自己的检查中是可能的。</p>
<p><strong>安装</strong></p>
<p>pip install pylint</p>
<p>pylint –version</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">pylint</span> <span class="mf">2.0</span><span class="o">.</span><span class="mi">0</span>
<span class="n">astroid</span> <span class="mf">2.0</span><span class="o">.</span><span class="mi">1</span>
<span class="n">Python</span> <span class="mf">3.5</span><span class="o">.</span><span class="mi">2</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Nov</span> <span class="mi">23</span> <span class="mi">2017</span><span class="p">,</span> <span class="mi">16</span><span class="p">:</span><span class="mi">37</span><span class="p">:</span><span class="mi">01</span><span class="p">)</span>
<span class="p">[</span><span class="n">GCC</span> <span class="mf">5.4</span><span class="o">.</span><span class="mi">0</span> <span class="mi">20160609</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>使用</strong></p>
<p>pylint [options] module_or_package</p>
<p>pylint test.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*************</span> <span class="n">Module</span> <span class="n">test</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">11</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">C0301</span><span class="p">:</span> <span class="n">Line</span> <span class="n">too</span> <span class="n">long</span> <span class="p">(</span><span class="mi">135</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="n">line</span><span class="o">-</span><span class="n">too</span><span class="o">-</span><span class="n">long</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">47</span><span class="p">:</span> <span class="n">C0326</span><span class="p">:</span> <span class="n">Exactly</span> <span class="n">one</span> <span class="n">space</span> <span class="n">required</span> <span class="n">after</span> <span class="n">comma</span>
    <span class="n">response</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">request</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="n">data_url</span><span class="p">,</span><span class="n">headers</span><span class="o">=</span><span class="n">headers</span><span class="p">,</span><span class="n">params</span><span class="o">=</span><span class="n">params</span><span class="p">)</span>
                                               <span class="o">^</span> <span class="p">(</span><span class="n">bad</span><span class="o">-</span><span class="n">whitespace</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">36</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">C0301</span><span class="p">:</span> <span class="n">Line</span> <span class="n">too</span> <span class="n">long</span> <span class="p">(</span><span class="mi">113</span><span class="o">/</span><span class="mi">100</span><span class="p">)</span> <span class="p">(</span><span class="n">line</span><span class="o">-</span><span class="n">too</span><span class="o">-</span><span class="n">long</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">1</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">C0111</span><span class="p">:</span> <span class="n">Missing</span> <span class="n">module</span> <span class="n">docstring</span> <span class="p">(</span><span class="n">missing</span><span class="o">-</span><span class="n">docstring</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">10</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">C0103</span><span class="p">:</span> <span class="n">Constant</span> <span class="n">name</span> <span class="s2">&quot;headers&quot;</span> <span class="n">doesn</span><span class="s1">&#39;t conform to UPPER_CASE naming style (invalid-name)</span>
<span class="o">...</span><span class="n">省略部分</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">14</span><span class="p">:</span><span class="mi">18</span><span class="p">:</span> <span class="n">W0621</span><span class="p">:</span> <span class="n">Redefining</span> <span class="n">name</span> <span class="s1">&#39;school_name&#39;</span> <span class="kn">from</span> <span class="nn">outer</span> <span class="n">scope</span> <span class="p">(</span><span class="n">line</span> <span class="mi">68</span><span class="p">)</span> <span class="p">(</span><span class="n">redefined</span><span class="o">-</span><span class="n">outer</span><span class="o">-</span><span class="n">name</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">0</span><span class="p">:</span> <span class="n">C0111</span><span class="p">:</span> <span class="n">Missing</span> <span class="n">function</span> <span class="n">docstring</span> <span class="p">(</span><span class="n">missing</span><span class="o">-</span><span class="n">docstring</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">33</span><span class="p">:</span><span class="mi">4</span><span class="p">:</span> <span class="n">W0622</span><span class="p">:</span> <span class="n">Redefining</span> <span class="n">built</span><span class="o">-</span><span class="ow">in</span> <span class="s1">&#39;id&#39;</span> <span class="p">(</span><span class="n">redefined</span><span class="o">-</span><span class="n">builtin</span><span class="p">)</span>
<span class="n">test</span><span class="o">.</span><span class="n">py</span><span class="p">:</span><span class="mi">32</span><span class="p">:</span><span class="mi">12</span><span class="p">:</span> <span class="n">W0621</span><span class="p">:</span> <span class="n">Redefining</span> <span class="n">name</span> <span class="s1">&#39;school&#39;</span> <span class="kn">from</span> <span class="nn">outer</span> <span class="n">scope</span> <span class="p">(</span><span class="n">line</span> <span class="mi">72</span><span class="p">)</span> <span class="p">(</span><span class="n">redefined</span><span class="o">-</span><span class="n">outer</span><span class="o">-</span><span class="n">name</span><span class="p">)</span>

<span class="o">------------------------------------------------------------------</span>
<span class="n">Your</span> <span class="n">code</span> <span class="n">has</span> <span class="n">been</span> <span class="n">rated</span> <span class="n">at</span> <span class="mf">3.33</span><span class="o">/</span><span class="mi">10</span> <span class="p">(</span><span class="n">previous</span> <span class="n">run</span><span class="p">:</span> <span class="mf">3.33</span><span class="o">/</span><span class="mi">10</span><span class="p">,</span> <span class="o">+</span><span class="mf">0.00</span><span class="p">)</span>
</pre></div>
</div>
<p>发现 Pylint 还会给代码整体打一个分数，我们就可以根据提示一步步调优，提高分数！10 分满分。</p>
<p>如果运行两次 Pylint，它会同时显示出当前和上次的运行结果，从而可以看出代码质量是否得到了改进。</p>
<p>错误代码含义</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>C：惯例，违反了编码风格标准
R：重构，代码非常糟糕
W：警告，某些 Python 特定的问题
E：错误，很可能是代码中的错误
F：致命错误，阻止 Pylint 进一步运行的错误
</pre></div>
</div>
</div>
<div class="section" id="for-else">
<h3>for - else<a class="headerlink" href="#for-else" title="永久链接至标题">¶</a></h3>
<p>for 和 else 也是一对，而且是合法的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
<span class="go">    print(i)</span>
<span class="go">else:</span>
<span class="go">    print(i, &#39;我是else&#39;)</span>

<span class="go">1</span>
<span class="go">2</span>
<span class="go">3</span>
<span class="go">4</span>
<span class="go">4 我是else</span>
</pre></div>
</div>
<p>如果在 for 和 else 之间（循环体内）有if ，也不会影响 for 和 else 的关系。因为 for 的级别比 if 高，else
根本不在乎是否有 if，以及是否执行了满足 if 条件的语句。else 的眼里只有 for，只要 for 顺利执行完毕，
else 就会跑一遍：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
<span class="go">    if i &gt; 2:</span>
<span class="go">        print(i)</span>
<span class="go">else:</span>
<span class="go">    print(i, &#39;我是else&#39;)</span>

<span class="go">3</span>
<span class="go">4</span>
<span class="go">4 我是else</span>
</pre></div>
</div>
<p>那么，如何拆散 for 和 else 呢？只有当 for 循环被 break 语句中断之后，才会跳过 else 语句：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
<span class="go">    if i&gt;2:</span>
<span class="go">        print(i)</span>
<span class="go">        break</span>
<span class="go">else:</span>
<span class="go">    print(i, &#39;我是else&#39;)</span>

<span class="go">3</span>
</pre></div>
</div>
</div>
<div class="section" id="id3">
<h3>一颗星()和两颗星(*)<a class="headerlink" href="#id3" title="永久链接至标题">¶</a></h3>
<p>Python 函数支持默认参数和可变参数，一颗星表示不限数量的单值参数，两颗星表示不限数量的键值对参数。 我们还是举例说明吧：
设计一个函数，返回多个输入数值的和。我们固然可以把这些输入数值做成一个list传给函数，但这个方法，远没有使用一颗星的可变
参数来得优雅：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">multi_sum</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">):</span>
<span class="go">s = 0</span>
<span class="go">for item in args:</span>
<span class="go">    s += item</span>
<span class="go">return s</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">multi_sum</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
<span class="go">12</span>
</pre></div>
</div>
<p>Python 函数允许同时全部或部分使用固定参数、默认参数、单值（一颗星）可变参数、键值对（两颗星）可变参数，使用时必须按照前述顺序书写。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">do_something</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">age</span><span class="p">,</span> <span class="n">gender</span><span class="o">=</span><span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwds</span><span class="p">):</span>
<span class="go">print(&#39;姓名：%s，年龄：%d，性别：%s&#39;%(name, age, gender))</span>
<span class="go">print(args)</span>
<span class="go">print(kwds)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">do_something</span><span class="p">(</span><span class="s1">&#39;xufive&#39;</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="s1">&#39;男&#39;</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">75</span><span class="p">,</span> <span class="n">math</span><span class="o">=</span><span class="mi">99</span><span class="p">,</span> <span class="n">english</span><span class="o">=</span><span class="mi">90</span><span class="p">)</span>
<span class="go">姓名：qqq，年龄：50，性别：男</span>
<span class="go">(175, 75)</span>
<span class="go">{&#39;math&#39;: 99, &#39;english&#39;: 90}</span>
</pre></div>
</div>
</div>
<div class="section" id="id4">
<h3>三元表达式<a class="headerlink" href="#id4" title="永久链接至标题">¶</a></h3>
<p>熟悉 C/C++ 的程序员，初上手 python 时，一定会怀念经典的三元操作符，因为想表达同样的思想，用python 写起来似乎更麻烦。比如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
<span class="go">    print(&#39;y是一个负数&#39;)</span>
<span class="go">else:</span>
<span class="go">    print(&#39;y是一个非负数&#39;)</span>

<span class="go">y是一个非负数</span>
</pre></div>
</div>
<p>其实，python 是支持三元表达式的，只是稍微怪异了一点，类似于我们山东人讲话。比如，山东人最喜欢用倒装句：打球去吧，要是不下雨的话；下雨，咱就去自习室。翻译成三元表达式就是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">打球去吧</span> <span class="k">if</span> <span class="n">不下雨</span> <span class="k">else</span> <span class="n">去自习室</span>
</pre></div>
</div>
<p>来看看三元表达式具体的使用：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="s1">&#39;y是一个负数&#39;</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="s1">&#39;y是一个非负数&#39;</span><span class="p">)</span>
<span class="go">y是一个非负数</span>
</pre></div>
</div>
<p>python 的三元表达式也可以用来赋值：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">y</span> <span class="o">=</span> <span class="mi">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span> <span class="k">if</span> <span class="n">y</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">1</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">x</span>
<span class="go">1</span>
</pre></div>
</div>
</div>
<div class="section" id="with-as">
<h3>with - as<a class="headerlink" href="#with-as" title="永久链接至标题">¶</a></h3>
<p>with 语句适合一些事先需要准备，事后需要处理的任务，比如，文件操作，需要先打开文件，操作完成后需要关闭文件。如果不使用with，
文件操作通常得这样：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">fp</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;D:\Column\temp\mpmap.py&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">contents</span> <span class="o">=</span> <span class="n">fp</span><span class="o">.</span><span class="n">readlines</span><span class="p">()</span>
<span class="k">finally</span><span class="p">:</span>
    <span class="n">fp</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
</pre></div>
</div>
<p>如果使用 with - as，那就优雅多了：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;D:\Column\temp\mpmap.py&quot;</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fp</span><span class="p">:</span>
<span class="go">contents = fp.readlines()</span>
</pre></div>
</div>
</div>
<div class="section" id="id5">
<h3>列表推导式<a class="headerlink" href="#id5" title="永久链接至标题">¶</a></h3>
<p>在各种稀奇古怪的语法中，列表推导式的使用频率应该时最高的，对于代码的简化效果也非常明显。比如，求列表各元素的平方，通常应该这样写
（当然也有其他写法，比如使用map函数）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="nb">list</span><span class="p">()</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
<span class="go">    result.append(i*i)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">[1, 4, 9, 16, 25]</span>
</pre></div>
</div>
<p>如果使用列表推导式，看起来就舒服多了：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span> <span class="o">=</span> <span class="p">[</span><span class="n">i</span><span class="o">*</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">result</span>
<span class="go">[1, 4, 9, 16, 25]</span>
</pre></div>
</div>
<p>事实上，推导式不仅支持列表，也支持字典、集合、元组等对象。有兴趣的话，可以自行研究。有一篇博文《一行 Python 代码能实现什么丧心病
狂的功能？》，里面的例子，都是列表推导式实现的。</p>
</div>
<div class="section" id="id6">
<h3>列表索引的各种操作<a class="headerlink" href="#id6" title="永久链接至标题">¶</a></h3>
<p>Python 引入负整数作为数组的索引，这绝对是喜大普奔之举。想想看，在C/C++中，想要数组最后一个元素，得先取得数组长度，减一之后做索引，
严重影响了思维的连贯性。Python语言之所以获得成功，我个人觉得，在诸多因素里面，列表操作的便捷性是不容忽视的一点。请看：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">4</span><span class="p">]</span>
<span class="go">[2, 3]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:]</span>
<span class="go">[3, 4, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span>
<span class="go">[1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[:]</span>
<span class="go">[0, 1, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[::</span><span class="mi">2</span><span class="p">]</span>
<span class="go">[0, 2, 4]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">::</span><span class="mi">2</span><span class="p">]</span>
<span class="go">[1, 3, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">5</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span>
<span class="go">4</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">[1, 2, 3, 4]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
<span class="go">[5, 4, 3, 2, 1, 0]</span>
</pre></div>
</div>
<p>如果说，这些你都很熟悉，也经常用，那么接下来这个用法，你一定会感觉很神奇：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">b</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">2</span><span class="p">:</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">[0, 1, &#39;a&#39;, &#39;b&#39;, 2, 3, 4, 5]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span><span class="p">[</span><span class="mi">3</span><span class="p">:</span><span class="mi">6</span><span class="p">]</span> <span class="o">=</span> <span class="n">b</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">[0, 1, &#39;a&#39;, &#39;a&#39;, &#39;b&#39;, 4, 5]</span>
</pre></div>
</div>
</div>
<div class="section" id="lambda">
<h3>lambda函数<a class="headerlink" href="#lambda" title="永久链接至标题">¶</a></h3>
<p>lambda 听起来很高大上，其实就是匿名函数（了解js的同学一定很熟悉匿名函数）。匿名函数的应用场景是什么呢？
就是仅在定义匿名函数的地方使用这个函数，其他地方用不到。下面是
一个求和的匿名函数，输入参数有两个，x和y，函数体就是x+y，省略了return关键字。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span>
<span class="go">&lt;function &lt;lambda&gt; at 0x000001B2DE5BD598&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">,</span><span class="n">y</span><span class="p">:</span> <span class="n">x</span><span class="o">+</span><span class="n">y</span><span class="p">)(</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">)</span> <span class="c1"># 因为匿名函数没有名字，使用的时候要用括号把它包起来</span>
</pre></div>
</div>
<p>匿名函数一般不会单独使用，而是配合其他方法，为其他方法提供内置的算法或判断条件。比如，使用排序函数sorted对多维
数组或者字典排序时，就可以指定排序规则。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">50</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">30</span><span class="p">},</span> <span class="p">{</span><span class="s1">&#39;name&#39;</span><span class="p">:</span><span class="s1">&#39;C&#39;</span><span class="p">,</span> <span class="s1">&#39;age&#39;</span><span class="p">:</span><span class="mi">40</span><span class="p">}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;name&#39;</span><span class="p">])</span> <span class="c1"># 按姓名排序</span>
<span class="go">[{&#39;name&#39;: &#39;A&#39;, &#39;age&#39;: 30}, {&#39;name&#39;: &#39;B&#39;, &#39;age&#39;: 50}, {&#39;name&#39;: &#39;C&#39;, &#39;age&#39;: 40}]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="nb">sorted</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="p">[</span><span class="s1">&#39;age&#39;</span><span class="p">])</span> <span class="c1"># 按年龄排序</span>
<span class="go">[{&#39;name&#39;: &#39;A&#39;, &#39;age&#39;: 30}, {&#39;name&#39;: &#39;C&#39;, &#39;age&#39;: 40}, {&#39;name&#39;: &#39;B&#39;, &#39;age&#39;: 50}]</span>
</pre></div>
</div>
<p>再举一个数组元素求平方的例子，这次用map函数：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span><span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="n">a</span><span class="p">):</span>
<span class="go">    print(item, end=&#39;, &#39;)</span>

<span class="go">1, 4, 9,</span>
</pre></div>
</div>
</div>
<div class="section" id="yield">
<h3>yield 以及生成器和迭代器<a class="headerlink" href="#yield" title="永久链接至标题">¶</a></h3>
<p>py2时代，range()返回的是list，
但如果range(10000000)的话，会消耗大量内存资源，所以，py2又搞了一个xrange()来解决这个问题。py3则只保留了xrange()，
但写作range()。xrange()返回的就是一个迭代器，它可以像list那样被遍历，但又不占用多少内存。generator（生成器）是一种特殊的迭代器，
只能被遍历一次，遍历结束，就自动消失了。总之，不管是迭代器还是生成器，都是为了避免使用list，从而节省内存。那么，如何得到迭代器和
生成器呢？ python置了迭代函数 iter，用于生成迭代器，用法如下：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">]</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a_iter</span> <span class="o">=</span> <span class="nb">iter</span><span class="p">(</span><span class="n">a</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a_iter</span>
<span class="go">&lt;list_iterator object at 0x000001B2DE434BA8&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a_iter</span><span class="p">:</span>
<span class="go">    print(i, end=&#39;, &#39;)</span>

<span class="go">1, 2, 3,</span>
</pre></div>
</div>
<p>yield 则是用于构造生成器的。比如，我们要写一个函数，返回从0到某正整数的所有整数的平方，传统的代码写法是这样的：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_square</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="go">result = list()</span>
<span class="go">for i in range(n):</span>
<span class="go">    result.append(pow(i,2))</span>
<span class="go">return result</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nb">print</span><span class="p">(</span><span class="n">get_square</span><span class="p">(</span><span class="mi">5</span><span class="p">))</span>
<span class="go">[0, 1, 4, 9, 16]</span>
</pre></div>
</div>
<p>但是如果计算1亿以内的所有整数的平方，这个函数的内存开销会非常大，这是 yield 就可以大显身手了：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">get_square</span><span class="p">(</span><span class="n">n</span><span class="p">):</span>
<span class="go">    for i in range(n):</span>
<span class="go">        yield(pow(i,2))</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span> <span class="o">=</span> <span class="n">get_square</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">a</span>
<span class="go">&lt;generator object get_square at 0x000001B2DE5CACF0&gt;</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="n">a</span><span class="p">:</span>
<span class="go">    print(i, end=&#39;, &#39;)</span>

<span class="go">0, 1, 4, 9, 16,</span>
</pre></div>
</div>
<p>如果再次遍历，则不会有输出了。</p>
</div>
<div class="section" id="id7">
<h3>装饰器<a class="headerlink" href="#id7" title="永久链接至标题">¶</a></h3>
<p>假如我们需要定义很多个函数，在每个函数运行的时候要显示这个函数的运行时长，解决方案有很多。比如，
可以在调用每个函数之前读一下时间戳，每个函数运行结束后再读一下时间戳，求差即可；也可以在每个函数体内的开始和结束位
置上读时间戳，最后求差。不过，这两个方法，都没有使用装饰器那么简单、优雅。下面的例子，很好地展示了这一点。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">time</span>
<span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">func</span><span class="p">):</span>
<span class="go">    def wrapper(*args,**kwds):</span>
<span class="go">        t0 = time.time()</span>
<span class="go">        func(*args,**kwds)</span>
<span class="go">        t1 = time.time()</span>
<span class="go">        print(&#39;耗时%0.3f&#39;%(t1-t0,))</span>
<span class="go">    return wrapper</span>

<span class="gp">&gt;&gt;&gt; </span><span class="nd">@timer</span>
<span class="go">def do_something(delay):</span>
<span class="go">    print(&#39;函数do_something开始&#39;)</span>
<span class="go">    time.sleep(delay)</span>
<span class="go">    print(&#39;函数do_something结束&#39;)</span>


<span class="gp">&gt;&gt;&gt; </span><span class="n">do_something</span><span class="p">(</span><span class="mi">3</span><span class="p">)</span>
<span class="go">函数do_something开始</span>
<span class="go">函数do_something结束</span>
<span class="go">耗时3.077</span>
</pre></div>
</div>
<p>timer() 是我们定义的装饰器函数，使用&#64;把它附加在任何一个函数（比如do_something）定义之前，就等于把新定义的函数，
当成了装饰器函数的输入参数。运行 do_something() 函数，可以理解为执行了timer(do_something) 。细节虽然复杂，不
过这么理解不会偏差太大，且更易于把握装饰器的制造和使用。</p>
</div>
<div class="section" id="assert">
<h3>断言assert<a class="headerlink" href="#assert" title="永久链接至标题">¶</a></h3>
<p>所谓断言，就是声明表达式的布尔值必须为真的判定，否则将触发 AssertionError 异常。严格来讲，assert是调试手段，不宜
使用在生产环境中，但这不影响我们用断言来实现一些特定功能，比如，输入参数的格式、类型验证等。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="k">def</span> <span class="nf">i_want_to_sleep</span><span class="p">(</span><span class="n">delay</span><span class="p">):</span>
<span class="go">assert(isinstance(delay, (int,float))), &#39;函数参数必须为整数或浮点数&#39;</span>
<span class="go">print(&#39;开始睡觉&#39;)</span>
<span class="go">time.sleep(delay)</span>
<span class="go">print(&#39;睡醒了&#39;)</span>

<span class="gp">&gt;&gt;&gt; </span><span class="n">i_want_to_sleep</span><span class="p">(</span><span class="mf">1.1</span><span class="p">)</span>
<span class="go">开始睡觉</span>
<span class="go">睡醒了</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i_want_to_sleep</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
<span class="go">开始睡觉</span>
<span class="go">睡醒了</span>
<span class="gp">&gt;&gt;&gt; </span><span class="n">i_want_to_sleep</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
<span class="gt">Traceback (most recent call last):</span>
  File <span class="nb">&quot;&lt;pyshell#247&gt;&quot;</span>, line <span class="m">1</span>, in <span class="n">&lt;module&gt;</span>
    <span class="n">i_want_to_sleep</span><span class="p">(</span><span class="s1">&#39;2&#39;</span><span class="p">)</span>
  File <span class="nb">&quot;&lt;pyshell#244&gt;&quot;</span>, line <span class="m">2</span>, in <span class="n">i_want_to_sleep</span>
    <span class="k">assert</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">delay</span><span class="p">,</span> <span class="p">(</span><span class="nb">int</span><span class="p">,</span><span class="nb">float</span><span class="p">))),</span> <span class="s1">&#39;函数参数必须为整数或浮点数&#39;</span>
</pre></div>
</div>
<p>AssertionError: 函数参数必须为整数或浮点数。</p>
</div>
</div>
<div class="section" id="id8">
<h2>算法<a class="headerlink" href="#id8" title="永久链接至标题">¶</a></h2>
<div class="section" id="id9">
<h3>算法的重要性<a class="headerlink" href="#id9" title="永久链接至标题">¶</a></h3>
<p>当你在工作中，大部分时间都是在调用一些api，copy和堆砌一堆需求代码，
你就知道是是你的工作过于简单。编程工作中，思维很重要，锻炼思维的方式之一，就是理解算法。
（有一部分算法解释篇幅过长，可能会引用网上博客资源，如有侵权，请及时联系作者）</p>
</div>
<div class="section" id="id10">
<h3>机器学习算法<a class="headerlink" href="#id10" title="永久链接至标题">¶</a></h3>
<div class="section" id="id11">
<h4>监督学习<a class="headerlink" href="#id11" title="永久链接至标题">¶</a></h4>
<p>监督学习其实就是我们对输入样本经过模型训练后有明确的预期输出，常见类型可分为”分类问题”和”回归问题”。</p>
<p>分类问题：
想要预测的是离散值。举例：预测肿瘤为良性或者恶性。</p>
<p>回归问题：
预测的是连续值。举例：房价预测。</p>
</div>
<div class="section" id="id12">
<h4>无监督学习<a class="headerlink" href="#id12" title="永久链接至标题">¶</a></h4>
<p>非监督学习就是我们对输入样本经过模型训练后得到什么输出完全没有预期。</p>
<p>聚类算法：
即将训练集中的西瓜分为若干组，每组称为一个“簇”；这些自动形成的簇可能对应一些潜在的概念划分，例如“浅色瓜”“深色瓜”，甚至“本地瓜”“外地瓜”。
举例：谷歌新闻。</p>
</div>
<div class="section" id="id13">
<h4>单变量线性回归<a class="headerlink" href="#id13" title="永久链接至标题">¶</a></h4>
<p>线性回归是监督学习中的重要算法，其主要目的在于用一个函数表示一组数据，其中横轴是变量（假定一个结果只由一个变量影响），纵轴是结果。
线性回归得到的方程，称为假设函数（Hypothesis Function）。当假设函数是线性函数时，其公式为：</p>
<img alt="../_images/假设函数.png" src="../_images/假设函数.png" />
<p>代价函数：
又称平方误差函数。代价函数是用于评价线性回归，其公式为：</p>
<img alt="../_images/代价函数.png" src="../_images/代价函数.png" />
<p>计算方式是计算每一个点在当前假设函数情况下，偏差的平方和，再取平均数。m即表示一共取了几个点进行判断。
因此可知，假设函数预计的越准确的，其代价函数的结果越接近于0。对于不同的假设函数，其J的结果可以形成一个轮廓图，如下：</p>
<img alt="../_images/代价函数轮廓图.png" src="../_images/代价函数轮廓图.png" />
<p>上图中，横坐标θ0表示与y轴的交点，纵坐标θ1表示斜率。同一个圆环，表示取值在这些范围内的假设函数，
其代价函数的结果是一样的，即这些取值情况下的精度是一样的。</p>
</div>
<div class="section" id="id14">
<h4>梯度下降算法<a class="headerlink" href="#id14" title="永久链接至标题">¶</a></h4>
<p>梯度下降（Gradientdescent）是获取代价函数最小值的过程。</p>
<p>1、思想</p>
<blockquote>
<div><p>想象现在在一座山（三维立体图形），有多个山峰和山谷（极大值和极小值）。当你在某个位置，找到最快下山的路线（偏导数最小而且是负数的方向），
并走一小步，然后接着寻找最快下山的路线，直到到达最低点。</p>
</div></blockquote>
<p>2、存在问题</p>
<blockquote>
<div><p>从上述思想可知，对于有多个极小值情况下，用梯度下降算法很有可能到不了最小值点，只会到达某个极小值点，就因为周围没有减小的路线，而停止。
因此，不同的起始值，最终得到的结果会不一样。</p>
</div></blockquote>
<p>3、步骤</p>
<blockquote>
<div><p>如下述公式：（图片来自视频课程）</p>
</div></blockquote>
<img alt="../_images/梯度下降.png" src="../_images/梯度下降.png" />
<p>其中，α就是“一小步”的距离，α取的大小的变化，会导致从一个点抵达的下一个点的位置不一样，会影响到最终抵达的位置。
不断的执行公式，最终会抵达一个结果。要求：每次更新的时候，θ1和θ0都要更新，即将θ0和θ1的结果都算出来后，才更新
θ0和θ1的值，进行下一次的计算。图中的“:=”符号，即赋值符号，对于大多数编程语言来说，就是=号。</p>
</div>
<div class="section" id="id15">
<h4>线性回归的梯度下降<a class="headerlink" href="#id15" title="永久链接至标题">¶</a></h4>
<p>线性回归的代价函数，没有局部最优解，只有全局最优解。</p>
<img alt="../_images/线性回归的梯度下降.png" src="../_images/线性回归的梯度下降.png" />
</div>
<div class="section" id="id16">
<h4>矩阵和向量<a class="headerlink" href="#id16" title="永久链接至标题">¶</a></h4>
<p>矩阵</p>
<img alt="../_images/矩阵.png" src="../_images/矩阵.png" />
<p>向量（一般为小写）</p>
<img alt="../_images/向量.png" src="../_images/向量.png" />
<p>矩阵的逆乘以矩阵为单位矩阵</p>
</div>
<div class="section" id="id17">
<h4>多变量线性回归<a class="headerlink" href="#id17" title="永久链接至标题">¶</a></h4>
<p>上面我们提到了单变量的线性回归模型，但是我们实际遇到的问题，都会有多个变量影响，比如上篇的例子——房价问题，
在实际情况下影响房价的一定不止房子的面积，房子的地理位置，采光度等等都会或多或少的影响房价，所以必须考虑更
多变量来使我们的预测模型更加精确，这里就教大家多变量的线性回归模型。</p>
<p>我们这次的例题还是用我们上次单变量线性回归模型一样的问题——房价问题，但是我们这次添加了房间数，房子所在楼层
数，房子面积这三个新变量到我们的例题中。</p>
<img alt="../_images/多变量线性回归房价问题.png" src="../_images/多变量线性回归房价问题.png" />
<p>我们把这四个变量命名为x1,x2,x3,x4结果为y，用n表示我们有n个特征，用m表示样本数量。既然我们多了这么多特征变量，
那么我们的模型的公式也要改变：</p>
<img alt="../_images/多变量线性回归公式.png" src="../_images/多变量线性回归公式.png" />
<p>但为了计算和表示的方便我们多设一个变量x0=1，也就是说我们的θ0 * x0，这样我们可以把特征表示成一个矩阵x =
[x0,x1,x2……..,xn]，同时我们的要求的参数θ也能表示成同长度的矩阵θ = [θ0,θ1,θ2…..,θ3]。</p>
<img alt="../_images/多变量线性回归公式转换成矩阵过程.png" src="../_images/多变量线性回归公式转换成矩阵过程.png" />
<p>这样我们的h(x)就可以表示成h(x) =(θ^T )*x</p>
<img alt="../_images/多变量线性回归矩阵表示公式.png" src="../_images/多变量线性回归矩阵表示公式.png" />
</div>
<div class="section" id="id18">
<h4>多元梯度下降<a class="headerlink" href="#id18" title="永久链接至标题">¶</a></h4>
<p>多元线性回归的代价函数和单变量的回归的代价函数是一样的，所以我们这里的梯度下降的方法和公式没有太大的差别，
都是原参数减去学习率与原参数在代价函数上的偏导的乘积：</p>
<img alt="../_images/多变量线性回归梯度下降.png" src="../_images/多变量线性回归梯度下降.png" />
</div>
<div class="section" id="id19">
<h4>特征缩放<a class="headerlink" href="#id19" title="永久链接至标题">¶</a></h4>
<p>虽然多元线性回归的梯度下降方法和单变量回归没有太大的差别，但是多元线性回归涉及到单变量回归没有的问题，
就是多个特征值的取值差别过大，导致模型很难拟合。这里我们需要运用特征缩放的方法对数据进行预处理。特征
缩放其实很简单，比如我们的两个变量房屋的面积和房间数。房屋的面积 的范围在0-2000英寸，而我们的房间数
在1-5间，这两个特征值就相差过大，导致梯度下降的困难。这里我们只需要把我们的房屋面积除以2000，房间数
除以5，这样我们两个特征值的范围就在0-1之间，梯度下降就更加容易。</p>
<img alt="../_images/多变量线性回归特征缩放.png" src="../_images/多变量线性回归特征缩放.png" />
</div>
<div class="section" id="id20">
<h4>学习率<a class="headerlink" href="#id20" title="永久链接至标题">¶</a></h4>
<p>这里给的是学习率选择的技巧。
首先我们可以绘制出梯度下降迭代的次数和代价函数值的关系图，来判断函数是否收敛，从而判断这个学习率是否合适。</p>
<img alt="../_images/学习率.png" src="../_images/学习率.png" />
<p>学习率𝜶太小的话，可能导致梯度下降算法收敛缓慢。
学习率𝜶太大的话，可能导致J(𝜽)不会在每次迭代都下降。（相当于每次迈的步数过大，跳过了代价函数最小的点）</p>
<img alt="../_images/学习率2.png" src="../_images/学习率2.png" />
<p>我们推荐学习率的改变方式是每十倍取值，比如0.001偏小了我们下次就取0.01，再偏小再取0.1。</p>
</div>
<div class="section" id="id21">
<h4>特征与多项式回归<a class="headerlink" href="#id21" title="永久链接至标题">¶</a></h4>
<p>很多时候我们的数据分布不是直线型的，可能是曲线，也可能是其他图形，这里将教大家如何拟合非直线型函数。
比如这个房屋面积与价格的数据，我们可以看出来像一条抛物线，我们就可以用二次模型去拟合。如果后面继续上升了，
就像一个三次函数，我们就用三次模型去拟合，然后把每一项替换了。</p>
<img alt="../_images/特征与多项式回归.png" src="../_images/特征与多项式回归.png" />
<p>这个问题就转换成了用x1，x2，x3来建立回归。让我们的模型拟合度更高。但是要记住不要忘了特征缩放。毕竟三次和
一次的值会相差很大，增加梯度下降的难度。当然选择什么函数模型去拟合，还是取决于数据在坐标系上的分布像什么函数模型。</p>
</div>
<div class="section" id="id22">
<h4>正规方程<a class="headerlink" href="#id22" title="永久链接至标题">¶</a></h4>
<p>在我们给出例题的时候就想到了我们高中时候学过的最小二成法求回归方程，就会产生疑惑，我们明明可以直接求取各个参数，
为什么还要用梯度下降这种费时费力的方式来求回归方程呢？这里就给出了直接求取参数的正规方程。我们梯度下降的目的是
求出代价函数的取得最小值或者局部最小值的值，在我们高中就学过用导数等于零来求极大值和极小值，这里我们就是用代价
函数导数等于零来求参数的解。我门就是把逐个参数θ求代价函数J的偏导，然后把他们全部置零，并求解。</p>
<img alt="../_images/代价函数等于零求参.png" src="../_images/代价函数等于零求参.png" />
<p>但这样求解的方式很麻烦，所以这里给出一般解法，首先我们构建x0，x1，x3…..xn的所以特征值的一个矩阵，以及所有目
标值y的矩阵，这里我们给出一个例子：</p>
<img alt="../_images/构建特征值矩阵得正规方程.png" src="../_images/构建特征值矩阵得正规方程.png" />
<p>那么我们的参数的解也是一个矩阵，可以通过这个公式得到：</p>
<img alt="../_images/正规方程.png" src="../_images/正规方程.png" />
</div>
<div class="section" id="id23">
<h4>正规方程法与梯度下降法的比较<a class="headerlink" href="#id23" title="永久链接至标题">¶</a></h4>
<p>上面给出的正规方程解法，一步我们就可以得到我们想要的结果，是不是很方便，但是正规方程真的这么万能的话我们也不会
在前面废这么大的劲来讲解梯度下降法。这里我们就给出两种方法的优劣。
首先梯度下降我们要确定学习率，而且需要很多次迭代来训练，费时费力，正规方程则不需要。
但是我们特征过多的话，正规方程求解的时间维度是O（n ^ 3），这就需要比梯度下降更多的时间来求解。梯度下降适用于更
多的情况，而且符合机器学习的方法，所以我们在做机器学习更倾向于用梯度下降而不是用正规方程。</p>
</div>
</div>
<div class="section" id="octave">
<h3>octave<a class="headerlink" href="#octave" title="永久链接至标题">¶</a></h3>
<ol class="arabic simple">
<li></li>
</ol>
<p>基本操作</p>
<img alt="../_images/octave基本操作1.png" src="../_images/octave基本操作1.png" />
<img alt="../_images/octave基本操作2.png" src="../_images/octave基本操作2.png" />
<img alt="../_images/octave基本操作3.png" src="../_images/octave基本操作3.png" />
<img alt="../_images/octave基本操作4.png" src="../_images/octave基本操作4.png" />
<img alt="../_images/octave基本操作5.png" src="../_images/octave基本操作5.png" />
<img alt="../_images/octave基本操作6.png" src="../_images/octave基本操作6.png" />
</div>
<div class="section" id="id24">
<h3>基础概率知识<a class="headerlink" href="#id24" title="永久链接至标题">¶</a></h3>
<div class="section" id="id25">
<h4>协方差<a class="headerlink" href="#id25" title="永久链接至标题">¶</a></h4>
<p>在概率论和统计学中，协方差用于衡量两个变量的总体误差。而方差是协方差的一种特殊情况，即当两个变量是相同的情况。
期望值分别为E(X) = μ 与 E(Y) = ν 的两个实数随机变量X与Y之间的协方差定义为：
COV(X，Y)=E[(X-E(X))(Y-E(Y))]
其中，E是期望值。它也可以表示为：
直观上来看，协方差表示的是两个变量总体误差的方差，这与只表示一个变量误差的方差不同。
如果两个变量的变化趋势一致，也就是说如果其中一个大于自身的期望值，另外一个也大于自身的期望值，那么两个变量之间的协方差就是正值。
如果两个变量的变化趋势相反，即其中一个大于自身的期望值，另外一个却小于自身的期望值，那么两个变量之间的协方差就是负值。
如果X与Y是统计独立的，那么二者之间的协方差就是0。
但是，反过来并不成立。即如果X与Y的协方差为0，二者并不一定是统计独立的。
协方差cov(X,Y)的度量单位是X的协方差乘以Y的协方差。而取决于协方差的相关性，是一个衡量线性独立的无量纲的数。
协方差为0的两个随机变量称为是不相关的。</p>
<p><strong>协方差的意思和计算公式</strong></p>
<p>学过概率统计的孩子都知道，统计里最基本的概念就是样本的均值，方差，或者再加个标准差。首先我们给你一个含有n个样本的集合，依次给出这些
概念的公式描述，这些高中学过数学的孩子都应该知道吧，一带而过。</p>
<img alt="../_images/均值标准差方差.png" src="../_images/均值标准差方差.png" />
<p>很显然，均值描述的是样本集合的中间点，它告诉我们的信息是很有限的，而标准差给我们描述的则是样本集合的各个样本点到均值的距离之平均。以
这两个集合为例，[0，8，12，20]和[8，9，11，12]，两个集合的均值都是10，但显然两个集合差别是很大的，计算两者的标准差，前者是8.3，后
者是1.8，显然后者较为集中，故其标准差小一些，标准差描述的就是这种“散布度”。之所以除以n-1而不是除以n，是因为这样能使我们以较小的样本
集更好的逼近总体的标准差，即统计上所谓的“无偏估计”。而方差则仅仅是标准差的平方。</p>
<p><strong>为什么需要协方差？</strong></p>
<p>上面几个统计量看似已经描述的差不多了，但我们应该注意到，标准差和方差一般是用来描述一维数据的，但现实生活我们常常遇到含有多维数据的数据
集，最简单的大家上学时免不了要统计多个学科的考试成绩。面对这样的数据集，我们当然可以按照每一维独立的计算其方差，但是通常我们还想了解更
多，比如，一个男孩子的猥琐程度跟他受女孩子欢迎程度是否存在一些联系啊，嘿嘿~协方差就是这样一种用来度量两个随机变量关系的统计量，我们可以
仿照方差的定义：</p>
<img alt="../_images/方差定义.png" src="../_images/方差定义.png" />
<p>来度量各个维度偏离其均值的程度，标准差可以这么来定义：</p>
<img alt="../_images/标准差定义.png" src="../_images/标准差定义.png" />
<p>协方差的结果有什么意义呢？如果结果为正值，则说明两者是正相关的(从协方差可以引出“相关系数”的定义)，也就是说一个人越猥琐就越受女孩子欢迎，
嘿嘿，那必须的~结果为负值就说明负相关的，越猥琐女孩子越讨厌，可能吗？如果为0，也是就是统计上说的“相互独立”。
从协方差的定义上我们也可以看出一些显而易见的性质，如：</p>
<img alt="../_images/协方差性质.png" src="../_images/协方差性质.png" />
</div>
<div class="section" id="id26">
<h4>标准差（均方差）<a class="headerlink" href="#id26" title="永久链接至标题">¶</a></h4>
<p>标准差（Standard Deviation） ，也称均方差（mean square error），是各数据偏离平均数的距离的平均数，它是离均差平方和平均后的方根，
用σ表示。标准差是方差的算术平方根。标准差能反映一个数据集的离散程度。平均数相同的，标准差未必相同。
标准差可以反映平均数不能反映出的东西（比如稳定度等）。</p>
<img alt="../_images/样本标准差.png" src="../_images/样本标准差.png" />
</div>
<div class="section" id="id27">
<h4>方差<a class="headerlink" href="#id27" title="永久链接至标题">¶</a></h4>
<p>（variance)是在概率论和统计方差衡量随机变量或一组数据时离散程度的度量。概率论中方差用来度量随机变量和其数学期望（即均值）之间的偏离程度。统
计中的方差（样本方差）是各个数据分别与其平均数之差的平方的和的平均数。在许多实际问题中，研究方差即偏离程度有着重要意义。看这么一段文字可能有
些绕，那就先从公式入手。</p>
<p>对于一组随机变量或者统计数据，其期望值我们由E(X)表示，即随机变量或统计数据的均值，然后对各个数据与均值的差的平方求和，</p>
<img alt="../_images/数据与均值的差的平方求和.png" src="../_images/数据与均值的差的平方求和.png" />
<p>最后对它们再求期望值就得到了方差公式。</p>
<img alt="../_images/方差公式.png" src="../_images/方差公式.png" />
<p><strong>方差与标准差之间的关系</strong></p>
<img alt="../_images/方差与标准差之间的关系.png" src="../_images/方差与标准差之间的关系.png" />
<p>根号里的内容就是我们刚提到的</p>
<img alt="../_images/方差与标准差之间的关系2.png" src="../_images/方差与标准差之间的关系2.png" />
<p>那么问题来了，既然有了方差来描述变量与均值的偏离程度，那又搞出来个标准差干什么呢？
发现没有，方差与我们要处理的数据的量纲是不一致的，虽然能很好的描述数据与均值的偏离程度，但是处理结果是不符合我们的直观思维的。
举个例子：一个班级里有60个学生，平均成绩是70分，标准差是9，方差是81，成绩服从正态分布，那么我们通过方差不能直观的确定班级学生
与均值到底偏离了多少分，通过标准差我们就很直观的得到学生成绩分布在[61,79]范围的概率为0.6826，即约等于下图中的34.2%*2</p>
<img alt="../_images/方差例子.png" src="../_images/方差例子.png" />
<p><strong>均方差、均方误差又是什么？</strong></p>
<p>标准差（Standard Deviation） ，中文环境中又常称均方差，但不同于均方误差（mean squared error，均方误差是各数据偏离真实值的距离平方和的平均数，也即误差平方和的平均数，计算公式形式上接近方差，它的开方叫均方根误差，均方根误差才和标准差形式上接近），标准差是离均差平方和平均后的方根，用σ表示。标准差是方差的算术平方根。
从上面定义我们可以得到以下几点：
1、均方差就是标准差，标准差就是均方差
2、均方误差不同于均方误差
3、均方误差是各数据偏离真实值的距离平方和的平均数
举个例子：我们要测量房间里的温度，很遗憾我们的温度计精度不高，所以就需要测量5次，得到一组数据[x1,x2,x3,x4,x5],假设温度的真实值是x，数据与真实值的误差e=x-xi
那么均方误差MSE=</p>
<img alt="../_images/均方误差.png" src="../_images/均方误差.png" />
<p>总的来说，均方差是数据序列与均值的关系，而均方误差是数据序列与真实值之间的关系，所以我们只需要搞清楚真实值和均值之间的关系就行了。</p>
</div>
</div>
<div class="section" id="id28">
<h3>利用方差减少网络延时误差<a class="headerlink" href="#id28" title="永久链接至标题">¶</a></h3>
<p>数据传输过程中，每个包的延时不确定，有抖动，曾经在第一份工作的项目中，遇到一个需求：去除出一批延时数据中，波动最大的值和波动最小的值，
把剩下的延时数值求平均值，以得出单位时间内，延时平均值。</p>
<p>那么此时，就需要用到方差的知识了，详细解决记录如下：</p>
<img alt="../_images/方差计算延时波动.png" src="../_images/方差计算延时波动.png" />
</div>
</div>
<div class="section" id="django">
<h2>Django<a class="headerlink" href="#django" title="永久链接至标题">¶</a></h2>
<div class="section" id="id29">
<h3>Django目录结构<a class="headerlink" href="#id29" title="永久链接至标题">¶</a></h3>
<p>HelloWorld: 项目的容器。</p>
<p>manage.py: 一个实用的命令行工具，可让你以各种方式与该 Django 项目进行交互。</p>
<p>HelloWorld/__init__.py: 一个空文件，告诉 Python 该目录是一个 Python 包。</p>
<p>HelloWorld/settings.py: 该 Django 项目的设置/配置。</p>
<p>HelloWorld/urls.py: 该 Django 项目的 URL 声明; 一份由 Django 驱动的网站”目录”。</p>
<p>HelloWorld/wsgi.py: 一个 WSGI 兼容的 Web 服务器的入口，以便运行你的项目。</p>
</div>
<div class="section" id="id30">
<h3>Django创建启动默认服务器<a class="headerlink" href="#id30" title="永久链接至标题">¶</a></h3>
<p>创建项目：django-admin.py startproject 项目名</p>
<p>启动服务器：python manage.py runserver 0.0.0.0:8000</p>
<p>0.0.0.0 让其它电脑可连接到开发服务器，8000 为端口号。如果不说明，那么端口号默认为 8000。
在浏览器输入你服务器的ip及端口号，如果正常启动。</p>
<p><strong>启动Django 400错误</strong></p>
<p>启动django后，不能访问，报400错误。</p>
<p>原因：没有开启允许访问</p>
<p>处理：编辑HelloWorld目录下setting.py ，把其中的
ALLOWED_HOSTS=[]改成ALLOWED_HOSTS=[‘*’]</p>
<p><strong># 表示任意地址。#</strong></p>
</div>
<div class="section" id="id31">
<h3>Django模版渲染语言<a class="headerlink" href="#id31" title="永久链接至标题">¶</a></h3>
<p><strong>从字典中取值</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">time</span> <span class="ow">in</span> <span class="n">news</span><span class="o">.</span><span class="n">items</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">title</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">time</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="django-1-projectapp-runserver">
<h3>Django 源码学习（1）——建立project和app，及runserver<a class="headerlink" href="#django-1-projectapp-runserver" title="永久链接至标题">¶</a></h3>
<p>通过对django源码的学习，促进对web开发的了解。</p>
<p>这里选择了django stable/1.3.x 分支的源码。</p>
<p><strong>startproject 和 startapp</strong></p>
<p>在django中使用 django-admin.py startproject mysite 来建立project。生成代码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">mysite</span><span class="o">/</span>
<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="n">manage</span><span class="o">.</span><span class="n">py</span>
<span class="n">settings</span><span class="o">.</span><span class="n">py</span>
<span class="n">urls</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>在project中使用 python manage.py startapp polls 来建立app。生成代码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">polls</span><span class="o">/</span>
<span class="fm">__init__</span><span class="o">.</span><span class="n">py</span>
<span class="n">models</span><span class="o">.</span><span class="n">py</span>
<span class="n">tests</span><span class="o">.</span><span class="n">py</span>
<span class="n">views</span><span class="o">.</span><span class="n">py</span>
</pre></div>
</div>
<p>那这两个命令在django中是如何实现的呢？</p>
<p><strong>django-admin.py 和 manage.py 的工作原理</strong></p>
<p>django-admin.py源码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">django.core</span> <span class="k">import</span> <span class="n">management</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">management</span><span class="o">.</span><span class="n">execute_from_command_line</span><span class="p">()</span>
</pre></div>
</div>
<p>manage.py的源码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="kn">from</span> <span class="nn">django.core.management</span> <span class="k">import</span> <span class="n">execute_manager</span>
<span class="kn">import</span> <span class="nn">imp</span>
<span class="k">try</span><span class="p">:</span>
    <span class="n">imp</span><span class="o">.</span><span class="n">find_module</span><span class="p">(</span><span class="s1">&#39;settings&#39;</span><span class="p">)</span> <span class="c1"># Assumed to be in the same directory.</span>
<span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
    <span class="kn">import</span> <span class="nn">sys</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">stderr</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="s2">&quot;Error: Can&#39;t find the file &#39;settings.py&#39; in the &quot;</span>
                     <span class="s2">&quot;directory containing </span><span class="si">%r</span><span class="s2">. It appears you&#39;ve &quot;</span>
                     <span class="s2">&quot;customized things.</span><span class="se">\n</span><span class="s2">You&#39;ll have to run django-admin.py, &quot;</span>
                     <span class="s2">&quot;passing it your settings module.</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="vm">__file__</span><span class="p">)</span>
    <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

<span class="kn">import</span> <span class="nn">settings</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s2">&quot;__main__&quot;</span><span class="p">:</span>
    <span class="n">execute_manager</span><span class="p">(</span><span class="n">settings</span><span class="p">)</span>
</pre></div>
</div>
<p>他们都使用了django.core.management模块，查看该模块的代码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">execute_from_command_line</span><span class="p">(</span><span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">utility</span> <span class="o">=</span> <span class="n">ManagementUtility</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">execute_manager</span><span class="p">(</span><span class="n">settings_mod</span><span class="p">,</span> <span class="n">argv</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="n">setup_environ</span><span class="p">(</span><span class="n">settings_mod</span><span class="p">)</span>             <span class="c1"># &lt;-- 唯一的区别在此</span>
    <span class="n">utility</span> <span class="o">=</span> <span class="n">ManagementUtility</span><span class="p">(</span><span class="n">argv</span><span class="p">)</span>
    <span class="n">utility</span><span class="o">.</span><span class="n">execute</span><span class="p">()</span>
</pre></div>
</div>
<p>发现manage.py只是比django-manage.py多了setup_environ(settings_mod)一行而已。</p>
<p>继续查看setup_environ的源码：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># Set DJANGO_SETTINGS_MODULE appropriately.</span>
<span class="k">if</span> <span class="n">original_settings_path</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">original_settings_path</span>
<span class="k">else</span><span class="p">:</span>
    <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1">.</span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">project_name</span><span class="p">,</span> <span class="n">settings_name</span><span class="p">)</span>

<span class="c1"># Import the project module. We add the parent directory to PYTHONPATH to</span>
<span class="c1"># avoid some of the path errors new users can have.</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">project_directory</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">pardir</span><span class="p">))</span>
<span class="n">project_module</span> <span class="o">=</span> <span class="n">import_module</span><span class="p">(</span><span class="n">project_name</span><span class="p">)</span>
<span class="n">sys</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
<p>发现manage.py多做了2件事情</p>
<p>·设置环境变量DJANGO_SETTINGS_MODULE为当前project的settings文件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">os</span><span class="p">;</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="p">[</span><span class="s1">&#39;DJANGO_SETTINGS_MODULE&#39;</span><span class="p">]</span>
<span class="go">&#39;mysite.settings&#39;</span>
</pre></div>
</div>
<p>·将当前project的父目录放入PYTHONPATH，然后以模块的方式导入project，最后把父目录从PYTHONPATH中去掉。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="kn">import</span> <span class="nn">sys</span><span class="p">;</span> <span class="n">sys</span><span class="o">.</span><span class="n">modules</span><span class="p">[</span><span class="s1">&#39;mysite&#39;</span><span class="p">]</span>
<span class="go">&lt;module &#39;mysite&#39; from &#39;/home/yijingping/repos/mysite/../mysite/__init__.pyc&#39;&gt;</span>
</pre></div>
</div>
<p>所以实际上manage.py 等于</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">django</span><span class="o">-</span><span class="n">admin</span><span class="o">.</span><span class="n">py</span> <span class="o">--</span><span class="n">settings</span><span class="o">=</span><span class="n">mysite</span><span class="o">.</span><span class="n">settings</span> <span class="o">--</span><span class="n">pythonpath</span><span class="o">=/</span><span class="n">home</span><span class="o">/</span><span class="n">yijingping</span><span class="o">/</span><span class="n">repos</span><span class="o">/</span><span class="n">mysite</span><span class="o">/../</span>
<span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;mysite&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>manage.py 执行过程</strong></p>
<p>通过execute_manager()与execute_from_command_line()方法，可以看到Django命令主要通过
django.core.management.ManagementUtility类的入口execute()执行。</p>
<p>命令执行过程如下：</p>
<p>1.解析命令，获得要执行的子命令名称（如startapp）。通过继承自OptionParser的类LaxOptionParser解析命令行.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">subcommand</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
</pre></div>
</div>
<p>2.找出subcommand的完整路径</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span>
</pre></div>
</div>
<p>其中fetch_command调用get_commands从下面几个地方找命令。</p>
<blockquote>
<div><p>1.django/core/management/commands目录下的命令文件</p>
<p>2.project/&lt;INSTALLED_APPS&gt;/management/commands/目录下的命令文件</p>
<p>如果project存在，则会把startproject从命令中去掉。所以manage.py比django-admin.py少这个命令。</p>
</div></blockquote>
<p>3.根据返回的subcommand实例，执行run_from_argv()方法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="bp">self</span><span class="o">.</span><span class="n">fetch_command</span><span class="p">(</span><span class="n">subcommand</span><span class="p">)</span><span class="o">.</span><span class="n">run_from_argv</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">argv</span><span class="p">)</span>
</pre></div>
</div>
<p>从django.core.management.base.BaseCommand中可知run_from_argv()方法的调用过程：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">run_from_argv</span><span class="p">()</span> <span class="o">-&gt;</span>  <span class="n">execute</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">handle</span><span class="p">()</span>
</pre></div>
</div>
<p>所以我们自定义command的时候要继承BaseCommand，并实现handle()方法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Command</span><span class="p">(</span><span class="n">BaseCommand</span><span class="p">):</span>
 <span class="k">def</span> <span class="nf">handle</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
     <span class="k">pass</span>
</pre></div>
</div>
<p>handle()方法执行的结果就是最后的返回。</p>
<p><strong>Command命令</strong></p>
<p>在django/core/management/commands可以发现所有的系统命令。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>yijingping@yjp-pc:~/repos/django/django/core/management/commands$ ls
cleanup.py           diffsettings.py  inspectdb.py     runfcgi.py    sqlclear.py    sqlinitialdata.py    startapp.py      testserver.py
compilemessages.py   dumpdata.py      loaddata.py      runserver.py  sqlcustom.py   sql.py               startproject.py  validate.py
createcachetable.py  flush.py         makemessages.py  shell.py      sqlflush.py    sqlreset.py          syncdb.py
dbshell.py           __init__.py      reset.py         sqlall.py     sqlindexes.py  sqlsequencereset.py  test.py
</pre></div>
</div>
<p>我选择最常用的三个进行分析。</p>
<p><strong>startproject.py</strong></p>
<p>从django/conf/project_template拷贝工程代码到目录project_name下</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>class Command(LabelCommand):
def handle_label(self, project_name, **options):
    directory = os.getcwd()

    # 判断当前的project_name是否已经存在
    try:
        import_module(project_name)
    except ImportError:
        pass
    else:
        raise CommandError(&quot;%r conflicts with the name of an existing Python module and cannot be used as a project name. Please try another name.&quot; % project_name)

    # 从`django/conf/project_template`拷贝工程代码到目录project_name下
    copy_helper(self.style, &#39;project&#39;, project_name, directory)

    # 生成settings.py文件
    # Create a random SECRET_KEY hash, and put it in the main settings.
    main_settings_file = os.path.join(directory, project_name, &#39;settings.py&#39;)
    settings_contents = open(main_settings_file, &#39;r&#39;).read()
    fp = open(main_settings_file, &#39;w&#39;)
    secret_key = &#39;&#39;.join([choice(&#39;abcdefghijklmnopqrstuvwxyz0123456789!@#$%^&amp;*(-_=+)&#39;) for i in range(50)])
    settings_contents = re.sub(r&quot;(?&lt;=SECRET_KEY = &#39;)&#39;&quot;, secret_key + &quot;&#39;&quot;, settings_contents)
    fp.write(settings_contents)
    fp.close()，
</pre></div>
</div>
<p>通过查看django.core.management.base.copy_helper方法，可以发现，这个方法既可以copy project，也可以copy app。 并且在拷贝的过程中会将
urls.py和settings.py中的{{project_name}}变量替换成传入的project参数。</p>
<p><strong>startapp.py</strong></p>
<p>startapp.py 与 startproject.py 类似，只是拷贝的源目录换成django/conf/app_template而已。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">copy_helper</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">style</span><span class="p">,</span> <span class="s1">&#39;app&#39;</span><span class="p">,</span> <span class="n">app_name</span><span class="p">,</span> <span class="n">directory</span><span class="p">,</span> <span class="n">project_name</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>runserver.py</strong></p>
<p>在开发过程中，最常用的就是python manage.py runserver。它的执行过程到底是什么样的呢？</p>
<p>在runserver.py中的执行过程：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">handle</span><span class="p">()</span> <span class="o">-&gt;</span>  <span class="n">run</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">inner_run</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">django</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">servers</span><span class="o">.</span><span class="n">basehttp</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>在django/core/servers/basehttp.py中我们看到run()方法的定义：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">wsgi_handler</span><span class="p">,</span> <span class="n">ipv6</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="n">server_address</span> <span class="o">=</span> <span class="p">(</span><span class="n">addr</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="n">httpd</span> <span class="o">=</span> <span class="n">WSGIServer</span><span class="p">(</span><span class="n">server_address</span><span class="p">,</span> <span class="n">WSGIRequestHandler</span><span class="p">,</span> <span class="n">ipv6</span><span class="o">=</span><span class="n">ipv6</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">set_app</span><span class="p">(</span><span class="n">wsgi_handler</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>这其实是一个wsgi程序。其中的参数wsgi_handler是在runserver.py中传入的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.core.handlers.wsgi</span> <span class="k">import</span> <span class="n">WSGIHandler</span>
<span class="k">def</span> <span class="nf">get_handler</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">WSGIHandler</span><span class="p">()</span>
</pre></div>
</div>
<p>在django/core/handlers/wsgi.py找到WSGIHandler的定义：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">WSGIHandler</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">BaseHandler</span><span class="p">):</span>
<span class="n">initLock</span> <span class="o">=</span> <span class="n">Lock</span><span class="p">()</span>
<span class="n">request_class</span> <span class="o">=</span> <span class="n">WSGIRequest</span>

<span class="k">def</span> <span class="nf">__call__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

    <span class="c1"># 载入middleware</span>
    <span class="c1"># Set up middleware if needed. We couldn&#39;t do this earlier, because</span>
    <span class="c1"># settings weren&#39;t available.</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_middleware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">initLock</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="c1"># Check that middleware is still uninitialised.</span>
                <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_middleware</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">load_middleware</span><span class="p">()</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="c1"># Unload whatever middleware we got</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_request_middleware</span> <span class="o">=</span> <span class="kc">None</span>
                <span class="k">raise</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">initLock</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>

    <span class="c1"># 处理request</span>
    <span class="n">set_script_prefix</span><span class="p">(</span><span class="n">base</span><span class="o">.</span><span class="n">get_script_name</span><span class="p">(</span><span class="n">environ</span><span class="p">))</span>
    <span class="n">signals</span><span class="o">.</span><span class="n">request_started</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">request</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">UnicodeDecodeError</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s1">&#39;Bad Request (UnicodeDecodeError)&#39;</span><span class="p">,</span>
                <span class="n">exc_info</span><span class="o">=</span><span class="n">sys</span><span class="o">.</span><span class="n">exc_info</span><span class="p">(),</span>
                <span class="n">extra</span><span class="o">=</span><span class="p">{</span>
                    <span class="s1">&#39;status_code&#39;</span><span class="p">:</span> <span class="mi">400</span><span class="p">,</span>
                <span class="p">}</span>
            <span class="p">)</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">HttpResponseBadRequest</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_response</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">signals</span><span class="o">.</span><span class="n">request_finished</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">sender</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="vm">__class__</span><span class="p">)</span>

    <span class="c1"># 返回response</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">status_text</span> <span class="o">=</span> <span class="n">STATUS_CODE_TEXT</span><span class="p">[</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">]</span>
    <span class="k">except</span> <span class="ne">KeyError</span><span class="p">:</span>
        <span class="n">status_text</span> <span class="o">=</span> <span class="s1">&#39;UNKNOWN STATUS CODE&#39;</span>
    <span class="n">status</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">%s</span><span class="s1"> </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">status_code</span><span class="p">,</span> <span class="n">status_text</span><span class="p">)</span>
    <span class="n">response_headers</span> <span class="o">=</span> <span class="p">[(</span><span class="nb">str</span><span class="p">(</span><span class="n">k</span><span class="p">),</span> <span class="nb">str</span><span class="p">(</span><span class="n">v</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">items</span><span class="p">()]</span>
    <span class="k">for</span> <span class="n">c</span> <span class="ow">in</span> <span class="n">response</span><span class="o">.</span><span class="n">cookies</span><span class="o">.</span><span class="n">values</span><span class="p">():</span>
        <span class="n">response_headers</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="s1">&#39;Set-Cookie&#39;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">c</span><span class="o">.</span><span class="n">output</span><span class="p">(</span><span class="n">header</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">))))</span>
    <span class="n">start_response</span><span class="p">(</span><span class="n">status</span><span class="p">,</span> <span class="n">response_headers</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<div class="section" id="django-2-url">
<h3>Django 源码学习（2）——url路由<a class="headerlink" href="#django-2-url" title="永久链接至标题">¶</a></h3>
<p><strong>url路由</strong></p>
<p>url路由将url地址与views的处理方法对应起来。因此urls.py的配置是django中很重要的一块。 这一篇专门来分析django是如何做url路由的。</p>
<p><strong>入口</strong></p>
<p>在&lt;projetc&gt;/settings.py中有一行配置（我当前的project_name叫mysite）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">ROOT_URLCONF</span> <span class="o">=</span> <span class="s1">&#39;mysite.urls&#39;</span>
</pre></div>
</div>
<p>所以django url的总入口由settings的变量ROOT_URLCONF指定。</p>
<p><strong>配置</strong></p>
<p>要弄清楚django如何处理url配置，先要弄清楚几个概念</p>
<p><strong>URL模式（URL Pattern）</strong></p>
<p>URL模式是指在Django urls模块中，名为urlpatterns的元组中包含的每一个值。通常由patterns方法生成urlpatterns元组的内容。</p>
<p>每个URL模式都需要指定如下几个内容：</p>
<blockquote>
<div><p>·一个正则表达式字符串。</p>
<p>·一个可调用对象，通常为一个视图函数或一个指定视图函数路径的字符串。</p>
<p>·可选的要传递给视图函数的默认参数（字典形式）。</p>
<p>·一个可选的name参数。</p>
<p>·路径前缀，加在视图函数路径字符串的前面组成完整的视图函数路径。可以通过patterns方法的第一个参数指定.</p>
</div></blockquote>
<p>如果有include，则递归生成上面的模式。</p>
<p>类django.core.urlresolvers.RegexURLPattern用来表示Django URL模式.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegexURLPattern</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># 添加前缀</span>
    <span class="k">def</span> <span class="nf">add_prefix</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">prefix</span><span class="p">):</span>
        <span class="k">pass</span>

    <span class="c1"># 解析，并返回ResolveMatch</span>
    <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
        <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">ResolverMatch</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">callback</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="c1"># 根据第二个参数获取views的方法引用</span>
    <span class="k">def</span> <span class="nf">_get_callback</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_callback</span>
    <span class="n">callback</span> <span class="o">=</span> <span class="nb">property</span><span class="p">(</span><span class="n">_get_callback</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>URL分解器（URL Resolve）</strong></p>
<p>一个URL Resolve可以包含多个URL Pattern，也可以包含多个其他URL Resolve。 通过这种包含结构设计，实现Django对URL的层级解析。</p>
<p>URL分解器是Django实现app与项目解耦的关键。通常由include方法操作的URL配置模块，最终会被解释成为URL分解器。</p>
<p>每个URL分解器都需要指定如下几个内容:</p>
<blockquote>
<div><p>·一个正则表达式字符串。URL开始部分是否匹配正则表达式，如匹配，去除成功匹配部分后余下部分匹配包含的URL模式和URL分解器。</p>
<p>·URL配置模块名或URL配置模块的引用。</p>
<p>·可选的关键参数(字典形式)。</p>
<p>·可选的App名称.</p>
<p>·可选的名称空间名字.</p>
</div></blockquote>
<p>类django.core.urlresolvers.RegexURLResolver用来表示URL分解器.</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">RegexURLResolver</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">regex</span><span class="p">,</span> <span class="n">urlconf_name</span><span class="p">,</span> <span class="n">default_kwargs</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">namespace</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
     <span class="k">pass</span>

 <span class="c1"># Deep search 生成匹配模式，只调用一次</span>
 <span class="k">def</span> <span class="nf">_populate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="n">lookups</span> <span class="o">=</span> <span class="n">MultiValueDict</span><span class="p">()</span>
     <span class="n">namespaces</span> <span class="o">=</span> <span class="p">{}</span>
     <span class="n">apps</span> <span class="o">=</span> <span class="p">{}</span>
     <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="nb">reversed</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">url_patterns</span><span class="p">):</span>
         <span class="k">pass</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">_reverse_dict</span> <span class="o">=</span> <span class="n">lookups</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">_namespace_dict</span> <span class="o">=</span> <span class="n">namespaces</span>
     <span class="bp">self</span><span class="o">.</span><span class="n">_app_dict</span> <span class="o">=</span> <span class="n">apps</span>

 <span class="c1"># 顺序搜索模式，搜索到则返回ResolverMatch</span>
 <span class="k">def</span> <span class="nf">resolve</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">path</span><span class="p">):</span>
     <span class="n">tried</span> <span class="o">=</span> <span class="p">[]</span>
     <span class="n">match</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">regex</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
     <span class="k">if</span> <span class="n">match</span><span class="p">:</span>
         <span class="n">new_path</span> <span class="o">=</span> <span class="n">path</span><span class="p">[</span><span class="n">match</span><span class="o">.</span><span class="n">end</span><span class="p">():]</span>
         <span class="k">for</span> <span class="n">pattern</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">url_patterns</span><span class="p">:</span>
             <span class="k">return</span> <span class="n">ResolverMatch</span><span class="p">(</span><span class="n">sub_match</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="n">sub_match</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="n">sub_match_dict</span><span class="p">,</span> <span class="n">sub_match</span><span class="o">.</span><span class="n">url_name</span><span class="p">,</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">app_name</span> <span class="ow">or</span> <span class="n">sub_match</span><span class="o">.</span><span class="n">app_name</span><span class="p">,</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">namespace</span><span class="p">]</span> <span class="o">+</span> <span class="n">sub_match</span><span class="o">.</span><span class="n">namespaces</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>匹配结果（Resolver Match）</strong></p>
<p>匹配结果是指当URL被正确匹配时，需返回的匹配结果.</p>
<p>匹配结果需指定以下几个内容:</p>
<blockquote>
<div><p>·一个可调用对象。通常是视图函数
·视图函数参数。通常是URL模式中正则表达式命名组匹配的值
·视图函数关键字参数。通常是url方法中设置传递给视图函数的参数(字典形式)
·可选的URL名称参数。
·可选的APP名称参数。
·可选的命名空间参数。</p>
</div></blockquote>
<p>类django.core.urlresolvers.ResolverMatch用来表示匹配结果。ResolverMatch类实现了__getitem__方法，可以同元组操作一样,
获取视图函数引用与视图函数参数，从而具备调用视图函数的条件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">ResolverMatch</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
<span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">func</span><span class="p">,</span> <span class="n">args</span><span class="p">,</span> <span class="n">kwargs</span><span class="p">,</span> <span class="n">url_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">app_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">namespaces</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">func</span> <span class="o">=</span> <span class="n">func</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">args</span> <span class="o">=</span> <span class="n">args</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span> <span class="o">=</span> <span class="n">kwargs</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">app_name</span> <span class="o">=</span> <span class="n">app_name</span>
    <span class="o">...</span>

<span class="c1"># 在handler中使用该方法获取views方法的引用和参数</span>
<span class="k">def</span> <span class="nf">__getitem__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">index</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">func</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">args</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">kwargs</span><span class="p">)[</span><span class="n">index</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>URL配置处理过程</strong></p>
<p>类django.core.handlers.base.BaseHandler中get_response()方法对url做了处理。 其中第1、3步是url处理的重点。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
    <span class="s2">&quot;Returns an HttpResponse object for the given HttpRequest&quot;</span>
    <span class="kn">from</span> <span class="nn">django.core</span> <span class="k">import</span> <span class="n">exceptions</span><span class="p">,</span> <span class="n">urlresolvers</span>
    <span class="kn">from</span> <span class="nn">django.conf</span> <span class="k">import</span> <span class="n">settings</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 1. 用默认urlconf设置urlresolver</span>
        <span class="n">urlconf</span> <span class="o">=</span> <span class="n">settings</span><span class="o">.</span><span class="n">ROOT_URLCONF</span>
        <span class="n">urlresolvers</span><span class="o">.</span><span class="n">set_urlconf</span><span class="p">(</span><span class="n">urlconf</span><span class="p">)</span>
        <span class="n">resolver</span> <span class="o">=</span> <span class="n">urlresolvers</span><span class="o">.</span><span class="n">RegexURLResolver</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^/&#39;</span><span class="p">,</span> <span class="n">urlconf</span><span class="p">)</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="c1"># 2. 处理request middleware</span>
            <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_request_middleware</span><span class="p">:</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                    <span class="k">break</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="s2">&quot;urlconf&quot;</span><span class="p">):</span>
                    <span class="c1"># 3. 用自定义urlconf重置urlresolver</span>
                    <span class="n">urlconf</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">urlconf</span>
                    <span class="n">urlresolvers</span><span class="o">.</span><span class="n">set_urlconf</span><span class="p">(</span><span class="n">urlconf</span><span class="p">)</span>
                    <span class="n">resolver</span> <span class="o">=</span> <span class="n">urlresolvers</span><span class="o">.</span><span class="n">RegexURLResolver</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;^/&#39;</span><span class="p">,</span> <span class="n">urlconf</span><span class="p">)</span>

                <span class="c1"># 4. 获取ResolveMatch的值</span>
                <span class="n">callback</span><span class="p">,</span> <span class="n">callback_args</span><span class="p">,</span> <span class="n">callback_kwargs</span> <span class="o">=</span> <span class="n">resolver</span><span class="o">.</span><span class="n">resolve</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">path_info</span><span class="p">)</span>

                <span class="c1"># 5. 处理 view middleware</span>
                <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_view_middleware</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">callback</span><span class="p">,</span> <span class="n">callback_args</span><span class="p">,</span> <span class="n">callback_kwargs</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                        <span class="k">break</span>

            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="c1"># 6. 调用views中的方法</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">callback</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">callback_args</span><span class="p">,</span> <span class="o">**</span><span class="n">callback_kwargs</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">,</span> <span class="n">e</span><span class="p">:</span>
                    <span class="c1"># 7. 处理exception middleware</span>
                    <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_exception_middleware</span><span class="p">:</span>
                        <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">response</span><span class="p">:</span>
                            <span class="k">break</span>
                    <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                        <span class="k">raise</span>

            <span class="c1"># Complain if the view returned None (a common error).</span>
            <span class="k">if</span> <span class="n">response</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="c1"># 错误处理</span>

            <span class="c1"># 处理 template response middleware</span>
            <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="s1">&#39;render&#39;</span><span class="p">)</span> <span class="ow">and</span> <span class="n">callable</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_template_response_middleware</span><span class="p">:</span>
                    <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
                <span class="n">response</span> <span class="o">=</span> <span class="n">response</span><span class="o">.</span><span class="n">render</span><span class="p">()</span>

        <span class="k">except</span><span class="p">:</span>
            <span class="c1"># 错误处理</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="n">urlresolvers</span><span class="o">.</span><span class="n">set_urlconf</span><span class="p">(</span><span class="kc">None</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># 处理 response middleware</span>
        <span class="k">for</span> <span class="n">middleware_method</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">_response_middleware</span><span class="p">:</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">middleware_method</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_response_fixes</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">)</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="c1"># 错误处理</span>

    <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
</div>
<div class="section" id="django-3">
<h3>Django 源码学习（3）——中间件<a class="headerlink" href="#django-3" title="永久链接至标题">¶</a></h3>
<p>在上一篇分析url配置处理过程的时候，看到调用views方法之前、之后都有很多对中间件（middleware）的操作。 这一篇则专门分析django中对
middleware的处理。</p>
<p><strong>中间件（middleware）</strong></p>
<p>Django的中间类型分为五种，特定的类型的中间件必须具有指定的方法：</p>
<blockquote>
<div><p>·请求中间件（Request Middleware）</p>
<p>process_request方法</p>
<p>·视图中间件（View Middleware）</p>
<p>process_view</p>
<p>·模板中间件（Template Response Middleware）</p>
<p>process_template_response</p>
<p>·响应中间件（Response Middleware）</p>
<p>process_response</p>
<p>·异常中间件（Exception Middleware）</p>
<p>process_exception</p>
</div></blockquote>
<p>可以存在一个类同时具有多个以上方法，即一个类可以同时是多种中间件。</p>
<p>中间件类必须使用无参__init__函数，创建类实例时，不需要任何参数。</p>
<p><strong>中间件加载顺序</strong></p>
<p>类django.core.handlers.base.BaseHandler中load_middleware()方法加载中间件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseHandler</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
 <span class="k">def</span> <span class="nf">load_middleware</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
     <span class="c1"># 从settings.MIDDLEWARE_CLASSES中获取中间件配置</span>
     <span class="k">for</span> <span class="n">middleware_path</span> <span class="ow">in</span> <span class="n">settings</span><span class="o">.</span><span class="n">MIDDLEWARE_CLASSES</span><span class="p">:</span>

         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mw_instance</span><span class="p">,</span> <span class="s1">&#39;process_request&#39;</span><span class="p">):</span>
             <span class="n">request_middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mw_instance</span><span class="o">.</span><span class="n">process_request</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mw_instance</span><span class="p">,</span> <span class="s1">&#39;process_view&#39;</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_view_middleware</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">mw_instance</span><span class="o">.</span><span class="n">process_view</span><span class="p">)</span>
         <span class="c1">## 注意下面3个和上面2个顺序不同，前者是FIFO，后者是FILO</span>
         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mw_instance</span><span class="p">,</span> <span class="s1">&#39;process_template_response&#39;</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_template_response_middleware</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mw_instance</span><span class="o">.</span><span class="n">process_template_response</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mw_instance</span><span class="p">,</span> <span class="s1">&#39;process_response&#39;</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_response_middleware</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mw_instance</span><span class="o">.</span><span class="n">process_response</span><span class="p">)</span>
         <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">mw_instance</span><span class="p">,</span> <span class="s1">&#39;process_exception&#39;</span><span class="p">):</span>
             <span class="bp">self</span><span class="o">.</span><span class="n">_exception_middleware</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">mw_instance</span><span class="o">.</span><span class="n">process_exception</span><span class="p">)</span>

 <span class="k">def</span> <span class="nf">get_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">):</span>
     <span class="k">pass</span>
</pre></div>
</div>
<p>从上面可以看出，middlare在配置中出现的顺序，跟他的处理顺序是相关的。 控制传入动作的中间件执行顺序是从上到下，控制返回动作的中间件执行顺序
是从下到上。 即请求中间与视图中间件的执行顺序是从上到下，模板中间件、异常中间件与响应中间件的执行顺序是从下到上.</p>
<p>如配置是：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>    <span class="n">MIDDLEWARE_CLASSES</span> <span class="o">=</span> <span class="p">(</span>
    <span class="s1">&#39;django.contrib.sessions.middleware.SessionMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.common.CommonMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.csrf.CsrfViewMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.auth.middleware.AuthenticationMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.contrib.messages.middleware.MessageMiddleware&#39;</span><span class="p">,</span>
    <span class="s1">&#39;django.middleware.clickjacking.XFrameOptionsMiddleware&#39;</span><span class="p">,</span>
<span class="p">)</span>
</pre></div>
</div>
<p>则处理过程如下图所示：</p>
<img alt="../_images/中间件加载顺序.png" src="../_images/中间件加载顺序.png" />
<p><strong>中间建处理过程</strong></p>
<p>类django.core.handlers.base.BaseHandler中get_response()方法使用中间件处理访问。</p>
<p>在前一篇已经分析过了，这里不重复分析，只贴结论：</p>
<p>1.应用请求中间件，处理传入请求。如果请求中间件方法process_request返回的response非空，则终止处理过程，执行步骤7。</p>
<p>2.url匹配，查找视图函数。</p>
<p>3.应用视图中间件，处理传入请求视图与视图参数。如果视图中间件方法process_view返回的response非空，则终止处理过程，执行步骤7。</p>
<p>4.调用视图函数。</p>
<p>5.如果视图函数抛出异常 ，应用异常中间件，处理传入请求与异常。如果异常中间件方法process_exception回的response非空，则终止处理过程。无论是否终止过程，都会跳到步骤7。</p>
<p>6.如果response支持延迟渲染，应用模板中间件。执行步骤7。</p>
<p>7.应用响应中间件，处理传入请求与中间件返回的response。</p>
<p>过程图如下：</p>
<p>过程中的图有2点错误:</p>
<p>·exception middleware应该在view视图函数的右边。</p>
<p>·在response middleware的前面有一层 template response middleware。</p>
<img alt="../_images/中间件处理过程.png" src="../_images/中间件处理过程.png" />
</div>
<div class="section" id="django-4-views">
<h3>Django 源码学习（4）—— Views模块<a class="headerlink" href="#django-4-views" title="永久链接至标题">¶</a></h3>
<p><strong>Views模块</strong></p>
<p>Views模块并不是Django中必须的，但是它的存在简化了Django的开发。</p>
<p>因为类django.core.handlers.base.BaseHandler中get_response()方法会回调views中的方法，并要求返回HttpResponse。 所以只要符合下面格
式的方法，都能作为views方法：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.http</span> <span class="k">import</span> <span class="n">HttpResponse</span>
<span class="k">def</span> <span class="nf">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="s2">&quot;html content&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>代码组织：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>django/views/
├── csrf.py
├── debug.py
├── decorators
│   ├── cache.py
│   ├── csrf.py
│   ├── gzip.py
│   ├── http.py
│   ├── __init__.py
│   └── vary.py
├── defaults.py
├── generic
│   ├── base.py
│   ├── create_update.py
│   ├── date_based.py
│   ├── dates.py
│   ├── detail.py
│   ├── edit.py
│   ├── __init__.py
│   ├── list_detail.py
│   ├── list.py
│   └── simple.py
├── i18n.py
├── __init__.py
└── static.py
</pre></div>
</div>
<p><strong>view decorators</strong></p>
<p>decorators中封装的函数和装饰器，可以非常方便的使用于reponse的压缩、安全、缓存设置。</p>
<p><strong>gzip.py</strong></p>
<p>我在开发api的时候，就经常用gzip，只要简单的一行，就可以返回gzip压缩后的response（如果在settings.middleware中设置了
django.middleware.gzip.GZipMiddleware，则会自动压缩）：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.views.decorators.gzip</span> <span class="k">import</span> <span class="n">gzip_page</span>
<span class="nd">@gzip_page</span>
<span class="k">def</span> <span class="nf">view_func</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="n">res</span> <span class="o">=</span> <span class="p">{</span><span class="o">...</span><span class="p">}</span>
    <span class="k">return</span> <span class="n">HttpResponse</span><span class="p">(</span><span class="n">simplejson</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">res</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s2">&quot;application/json; charset=utf-8&quot;</span><span class="p">)</span>
</pre></div>
</div>
<p>方法django.views.decorators.gzip.gzip_page其实很简单，它直接用django.middleware.gzip.GZipMiddleware包装了当前的view方法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">django.utils.decorators</span> <span class="k">import</span> <span class="n">decorator_from_middleware</span>
<span class="kn">from</span> <span class="nn">django.middleware.gzip</span> <span class="k">import</span> <span class="n">GZipMiddleware</span>

<span class="n">gzip_page</span> <span class="o">=</span> <span class="n">decorator_from_middleware</span><span class="p">(</span><span class="n">GZipMiddleware</span><span class="p">)</span>
<span class="n">gzip_page</span><span class="o">.</span><span class="vm">__doc__</span> <span class="o">=</span> <span class="s2">&quot;Decorator for views that gzips pages if the client supports it.&quot;</span>
</pre></div>
</div>
<p>类django.middleware.gzip.GZipMiddleware则处理了view返回的response，进行了gzip压缩，并设置相应的header。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">re_accepts_gzip</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;\bgzip\b&#39;</span><span class="p">)</span>
<span class="k">class</span> <span class="nc">GZipMiddleware</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="c1"># 处理views_func返回的response</span>
    <span class="k">def</span> <span class="nf">process_response</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">request</span><span class="p">,</span> <span class="n">response</span><span class="p">):</span>

        <span class="c1"># 判断是否已经压缩过</span>
        <span class="c1"># 判断是否Accept-Encoding是否有gzip</span>
        <span class="c1"># 对IE做特殊处理</span>
        <span class="c1"># ....</span>

        <span class="c1"># 压缩content, 设置header信息</span>
        <span class="n">response</span><span class="o">.</span><span class="n">content</span> <span class="o">=</span> <span class="n">compress_string</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">)</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Encoding&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="s1">&#39;gzip&#39;</span>
        <span class="n">response</span><span class="p">[</span><span class="s1">&#39;Content-Length&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">response</span><span class="o">.</span><span class="n">content</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">response</span>
</pre></div>
</div>
<p><strong>csrf.py</strong></p>
<p>Django CSRF与Gzip一样，最终也是调用middleware。</p>
<p>源代码中的原理是：</p>
<p>·第一次请求返回reponse的时候生成csrf写入cookie。（默认的key为’csrftoken’，也可以通过settings.CSRF_COOKIE_NAME来指定）
·第一次请求render template的时候在POST表单中，写入&lt;input type=”hidden” name=”csrfmiddlewaretoken” value=”$csrf_token”/&gt;
·提交的时候检查$request.COOKIES[‘csrftoken’] == $request.POST[‘csrfmiddlewaretoken’]，如果相等则通过，不相等则forbiden。</p>
<p><strong>cache.py</strong></p>
<p>通过get_cache()获取settings中配置的cache，中间件django.middleware.cache.CacheMiddleware 在process_request()中获取cache，
在process_response()中写入cache。</p>
<p><strong>http.py</strong></p>
<p>包含了 处理Etag和Last-Modified头，限制HTTP Method的装饰器。</p>
<p><strong>generic view</strong></p>
<p>django自动生成增、删、改、查、列表页面的视图类。它将web的基本操作进行了基本的封装，虽然灵活性降低了，但是用户写的代码更少了。</p>
<p>generic view中包含3中类型：</p>
<p>·View: 视图类，控制增删改查逻辑
·TemplateResponseMixin: 模板类，控制渲染模板
·ObjectMixin: 控制要传入的数据</p>
<p>basic views 的继承关系图：</p>
<img alt="../_images/basicview的继承关系图.png" src="../_images/basicview的继承关系图.png" />
</div>
<div class="section" id="django-400">
<h3>启动Django 400错误可能的原因<a class="headerlink" href="#django-400" title="永久链接至标题">¶</a></h3>
<p>启动django后，不能访问，报400错误。</p>
<p>原因：没有开启允许访问</p>
<p>处理：编辑HelloWorld目录下setting.py ，把其中的
ALLOWED_HOSTS=[]改成ALLOWED_HOSTS=[‘*’] ##* 表示任意地址。</p>
</div>
<div class="section" id="id32">
<h3>模版渲染语言，从字典中取值<a class="headerlink" href="#id32" title="永久链接至标题">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">%</span> <span class="k">for</span> <span class="n">title</span><span class="p">,</span><span class="n">time</span> <span class="ow">in</span> <span class="n">news</span><span class="o">.</span><span class="n">items</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">title</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="n">div</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">time</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">div</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="flask">
<h2>Flask<a class="headerlink" href="#flask" title="永久链接至标题">¶</a></h2>
<div class="section" id="flask-demo">
<h3>Flask Demo<a class="headerlink" href="#flask-demo" title="永久链接至标题">¶</a></h3>
<p><strong>1.安装flask模块</strong></p>
<p>pip install flask</p>
<p><strong>2.从flask模块导入Flask类</strong></p>
<p>from flask import Flask</p>
<p><strong>3.创建Flask类实例</strong></p>
<p>app = Flask(__name__)</p>
<p>__name__是应用模块或者包的名称，代表flask程序从__name__ == ‘__main__’处启动</p>
<p><strong>4.创建路由</strong></p>
<p>&#64;app.route(‘/’) 使用 route() 装饰器告诉 Flask 什么样的URL 能触发我们的函数</p>
<p><strong>5.启动项目</strong></p>
<p>app.run() 我们用 run() 函数来让应用运行在本地服务器上</p>
<p><strong>6.hello world小例子</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>
<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello_world</span><span class="p">():</span>
        <span class="k">return</span> <span class="s1">&#39;Hello World!&#39;</span>
<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
        <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id33">
<h3>Flask 框架知识点<a class="headerlink" href="#id33" title="永久链接至标题">¶</a></h3>
<div class="section" id="id34">
<h4>1.路由<a class="headerlink" href="#id34" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/projects/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">projects</span><span class="p">():</span>
    <span class="k">return</span> <span class="s2">&quot;hello&quot;</span>
</pre></div>
</div>
</div>
<div class="section" id="id35">
<h4>2.重定向<a class="headerlink" href="#id35" title="永久链接至标题">¶</a></h4>
<p>return redirect</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/projects/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">projects</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="s2">&quot;/main&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="url">
<h4>3.构造 URL<a class="headerlink" href="#url" title="永久链接至标题">¶</a></h4>
<p>可以用 url_for() 来给指定的函数构造 URL。它接受函数名作为第一个参数， 也接受对应 URL 规则的变量部分的命名参数。未知变量部分会添加到 URL 末 尾作为查询参数。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>from flask import Flask, url_for

app = Flask(__name__)

@app.route(&#39;/&#39;)
def index():
        pass

@app.route(&#39;/login&#39;)
def login():
        pass

@app.route(&#39;/user/&lt;username&gt;&#39;)
def profile(username):
        pass

with app.test_request_context():
        print url_for(&#39;index&#39;)
        print url_for(&#39;login&#39;)
        print url_for(&#39;login&#39;, next=&#39;/&#39;)
        print url_for(&#39;profile&#39;, username=&#39;John Doe&#39;)

结果：
/
/login
/login?next=/
/user/John%20Doe
</pre></div>
</div>
</div>
<div class="section" id="http">
<h4>4.HTTP 方法<a class="headerlink" href="#http" title="永久链接至标题">¶</a></h4>
<p>HTTP （与 Web 应用会话的协议）有许多不同的访问 URL 方法。默认情况下， 路由只回应 GET 请求，但是通过 route() 装饰器传递 methods 参数可以改变 这个行为。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
    <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
            <span class="n">do_the_login</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
            <span class="n">show_the_login_form</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id36">
<h4>5.静态文件<a class="headerlink" href="#id36" title="永久链接至标题">¶</a></h4>
<p>在你的包中或是模块的所在目录中创建一个名为 static 的文件夹，在应用中 使用 /static 即可访问。</p>
<p>url_for(‘static’, filename=’style.css’)这个文件应该存储在文件系统上的 static/style.css</p>
</div>
<div class="section" id="id37">
<h4>6.模板渲染<a class="headerlink" href="#id37" title="永久链接至标题">¶</a></h4>
<p>1.使用 render_template() 方法来渲染模板。你需要做的一切就是将模板名和 你想作为关键字的参数传入模板的变量。</p>
<p>2.{{}} 来表示变量名，这种 {{}} 语法叫做变量代码块</p>
<p>3.用 {%%} 定义的控制代码块，可以实现一些语言层次的功能，比如循环或者if 语句</p>
<p>4.使用 {# #} 进行注释，注释的内容不会在html中被渲染出来</p>
<p>python中的代码</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">render_template</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&#39;</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/myindexs/&lt;indexs&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">myindexs</span><span class="p">(</span><span class="n">indexs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">indexs</span><span class="o">=</span><span class="n">indexs</span><span class="p">)</span>
</pre></div>
</div>
<p>HTML中的代码</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">h1</span><span class="o">&gt;</span><span class="p">{{</span> <span class="n">name</span> <span class="p">}}</span><span class="o">&lt;/</span><span class="n">h1</span><span class="o">&gt;</span>
<span class="p">{</span><span class="o">%</span> <span class="k">if</span> <span class="n">name</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">there</span><span class="s1">&#39;s name attr</span>
<span class="p">{</span><span class="o">%</span> <span class="k">else</span> <span class="o">%</span><span class="p">}</span>
        <span class="n">there</span><span class="s1">&#39;s not name attr</span>
<span class="o">&lt;</span><span class="n">ul</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="n">indexs</span> <span class="o">%</span><span class="p">}</span>
        <span class="o">&lt;</span><span class="n">li</span><span class="o">&gt;</span> <span class="p">{{</span> <span class="n">index</span> <span class="p">}}</span> <span class="o">&lt;/</span><span class="n">li</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="o">%</span> <span class="n">endfor</span> <span class="o">%</span><span class="p">}</span>
<span class="o">&lt;/</span><span class="n">ul</span><span class="o">&gt;</span>
        <span class="p">{</span><span class="c1"># {{ name }} #}</span>
<span class="p">{</span><span class="o">%</span> <span class="n">endif</span> <span class="o">%</span><span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id38">
<h4>7.访问请求数据<a class="headerlink" href="#id38" title="永久链接至标题">¶</a></h4>
<p>通过 args 属性来访问 URL 中提交的参数</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>searchword = request.args[“data”]
</pre></div>
</div>
<p>通过files.get属性获取上传的文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">files</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;img&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id39">
<h4>8.获取表单数据<a class="headerlink" href="#id39" title="永久链接至标题">¶</a></h4>
<p>通过:attr:~flask.request.form 属性来访问表单数据（ POST 或 PUT 请求提交 的数据）。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;POST&#39;</span><span class="p">,</span> <span class="s1">&#39;GET&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
        <span class="n">error</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">valid_login</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">],</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;password&#39;</span><span class="p">]):</span>
                        <span class="k">return</span> <span class="n">log_the_user_in</span><span class="p">(</span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                        <span class="n">error</span> <span class="o">=</span> <span class="s1">&#39;Invalid username/password</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;login.html&#39;</span><span class="p">,</span> <span class="n">error</span><span class="o">=</span><span class="n">error</span><span class="p">)</span>
</pre></div>
</div>
<p>如果name属性有多个值，可以使用request.form.getlist(‘name’)，该方法将返回一个列表</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="o">.</span><span class="n">getlist</span><span class="p">(</span><span class="s1">&#39;name&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id40">
<h4>9.会话<a class="headerlink" href="#id40" title="永久链接至标题">¶</a></h4>
<p>session 对象。它允许你在不同请求间存储特定用户的信息。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">session</span><span class="p">,</span> <span class="n">redirect</span><span class="p">,</span> <span class="n">url_for</span><span class="p">,</span> <span class="n">escape</span><span class="p">,</span> <span class="n">request</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
        <span class="k">if</span> <span class="s1">&#39;username&#39;</span> <span class="ow">in</span> <span class="n">session</span><span class="p">:</span>
                <span class="k">return</span> <span class="s1">&#39;Logged in as </span><span class="si">%s</span><span class="s1">&#39;</span> <span class="o">%</span> <span class="n">escape</span><span class="p">(</span><span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">])</span>
        <span class="k">return</span> <span class="s1">&#39;You are not logged in&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/login&#39;</span><span class="p">,</span> <span class="n">methods</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;GET&#39;</span><span class="p">,</span> <span class="s1">&#39;POST&#39;</span><span class="p">])</span>
<span class="k">def</span> <span class="nf">login</span><span class="p">():</span>
        <span class="k">if</span> <span class="n">request</span><span class="o">.</span><span class="n">method</span> <span class="o">==</span> <span class="s1">&#39;POST&#39;</span><span class="p">:</span>
                <span class="n">session</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">request</span><span class="o">.</span><span class="n">form</span><span class="p">[</span><span class="s1">&#39;username&#39;</span><span class="p">]</span>
                <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
        <span class="k">return</span> <span class="s1">&#39;&#39;&#39;</span>
<span class="s1">                &lt;form action=&quot;&quot; method=&quot;post&quot;&gt;</span>
<span class="s1">                        &lt;p&gt;&lt;input type=text name=username&gt;</span>
<span class="s1">                        &lt;p&gt;&lt;input type=submit value=Login&gt;</span>
<span class="s1">                &lt;/form&gt;</span>
<span class="s1">        &#39;&#39;&#39;</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/logout&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">logout</span><span class="p">():</span>
        <span class="c1"># remove the username from the session if it&#39;s there</span>
        <span class="n">session</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;username&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">redirect</span><span class="p">(</span><span class="n">url_for</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">))</span>
</pre></div>
</div>
<p>获取session信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">session</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;is_login&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="id41">
<h4>10.蓝图划分<a class="headerlink" href="#id41" title="永久链接至标题">¶</a></h4>
<p>能够把你的应用依据许多能完成单一任务的小应用组织起来</p>
<p><strong>1.蓝图主界面</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>
<span class="kn">from</span> <span class="nn">user_app</span> <span class="k">import</span> <span class="n">user_app</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">register_blueprint</span><span class="p">(</span><span class="n">user_app</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>2.蓝图分界面</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Blueprint</span><span class="p">,</span> <span class="n">render_template</span>

<span class="n">user_app</span> <span class="o">=</span> <span class="n">Blueprint</span><span class="p">(</span><span class="s1">&#39;user_app&#39;</span><span class="p">,</span> <span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@user_app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/user/login&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">timeline</span><span class="p">(</span><span class="n">user_url_slug</span><span class="p">):</span>
        <span class="c1"># 做些处理</span>
        <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;/user/login.html&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="flaskjson">
<h3>Flask设置返回json格式数据<a class="headerlink" href="#flaskjson" title="永久链接至标题">¶</a></h3>
<p><strong>使用标准库json</strong></p>
<p>比较常见的是采用标准库json进行格式转换：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>这样当访问时即能够正常得到json数据。但这么做有一个缺点，就是HTTP返回的Content-Type仍然是text/html，即HTTP认为内容是HTML。</p>
<p><strong>声明Content-Type为json格式</strong></p>
<p>在上面的解决方法上作一个加强，手动指定其Content-Type为application/json，通常采用的是修改Flask中的Response模块：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span>
<span class="kn">import</span> <span class="nn">json</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">t</span><span class="p">),</span> <span class="n">mimetype</span><span class="o">=</span><span class="s1">&#39;application/json&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>这样不仅HTTP返回的内容是json，而且返回的Content-Type也是application/json了。</p>
<p><strong>使用Flask的jsonify模块</strong></p>
<p>实际上flask已经为json准备了专门的模块：jsonify。jsonify不仅会将内容转换为json，而且也会修改Content-Type为application/json。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>


<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">t</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p><strong>自定义Flask的Response，使用force_type()（2018.11.9更新）</strong></p>
<p>对于某些特殊的情况，可能并不想每个返回json数据的方法都使用jsonify()包起来，那有没有什么“非侵入式”的方法实现jsonify()的功能呢？其实是有的，不过这个方法相对比较高端。</p>
<p>Flask返回的内容实际是Response对象，return语句的内容实际是交给Response处理后才输出由HTTP返回的；也就是说，之前直接返回dict报错TypeError: ‘dict’ object is not callable也是Response干的。那么只需要在Response处理如dict等“非法”数据是，告诉Response该怎么做就好了，这里就是用到了其force_type()方法了，所有不能处理的数据，都由force_type()方法尝试处理后，再决定报错或通过。直接看例子吧。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="k">class</span> <span class="nc">MyResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">force_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">force_type</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">response_class</span> <span class="o">=</span> <span class="n">MyResponse</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>或者还可以以继承的方式来实现自定义Response，如：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span><span class="p">,</span> <span class="n">Response</span><span class="p">,</span> <span class="n">jsonify</span>

<span class="k">class</span> <span class="nc">MyResponse</span><span class="p">(</span><span class="n">Response</span><span class="p">):</span>
    <span class="nd">@classmethod</span>
    <span class="k">def</span> <span class="nf">force_type</span><span class="p">(</span><span class="bp">cls</span><span class="p">,</span> <span class="n">response</span><span class="p">,</span> <span class="n">environ</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="p">(</span><span class="nb">list</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)):</span>
            <span class="n">response</span> <span class="o">=</span> <span class="n">jsonify</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="nb">super</span><span class="p">(</span><span class="n">Response</span><span class="p">,</span> <span class="bp">cls</span><span class="p">)</span><span class="o">.</span><span class="n">force_type</span><span class="p">(</span><span class="n">response</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>

<span class="k">class</span> <span class="nc">MyFlask</span><span class="p">(</span><span class="n">Flask</span><span class="p">):</span>
    <span class="n">response_class</span> <span class="o">=</span> <span class="n">MyResponse</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">MyFlask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">root</span><span class="p">():</span>
    <span class="n">t</span> <span class="o">=</span> <span class="p">{</span>
        <span class="s1">&#39;a&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">,</span>
        <span class="s1">&#39;b&#39;</span><span class="p">:</span> <span class="mi">2</span><span class="p">,</span>
        <span class="s1">&#39;c&#39;</span><span class="p">:</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">]</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="n">t</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">True</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="section" id="id42">
<h3>Flask源码解读(一) 启动流程<a class="headerlink" href="#id42" title="永久链接至标题">¶</a></h3>
<p><strong>什么是WSGI</strong></p>
<p>Web Server Gateway Interface
它由Python标准定义的一套Web Server与Web Application的接口交互规范。
WSGI不是一个应用、框架、模块或者库，而是规范。
那什么是Web Server（Web服务器）和什么是Web Application（Web 应用）呢？
举例子来说明容易理解，例如常见的Web应用框架有Django、Flask等，而Web服务器有
uWSGI、Gunicorn等。WSGI就是定义了这两端接口交互的规范。</p>
<p><strong>什么是Werkzeug</strong></p>
<p>Werkzeug is a comprehensive WSGI web application library.
Werkzeug是一套实现WSGI规范的函数库。我们可以使用它来创建一个Web Application（Web应用）。
例如本文介绍的Flask应用框架就是基于Werkzeug来开发的。
这里我们使用Werkzeug启动一个简单的服务器应用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">werkzeug.wrappers</span> <span class="k">import</span> <span class="n">Request</span><span class="p">,</span> <span class="n">Response</span>

<span class="nd">@Request</span><span class="o">.</span><span class="n">application</span>
<span class="k">def</span> <span class="nf">application</span><span class="p">(</span><span class="n">request</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">Response</span><span class="p">(</span><span class="s1">&#39;Hello, World!&#39;</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="kn">from</span> <span class="nn">werkzeug.serving</span> <span class="k">import</span> <span class="n">run_simple</span>

    <span class="n">run_simple</span><span class="p">(</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="mi">4000</span><span class="p">,</span> <span class="n">application</span><span class="p">)</span>
</pre></div>
</div>
<p>运行之后可以在控制台上将看到如下信息</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">*</span> <span class="n">Running</span> <span class="n">on</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="n">localhost</span><span class="p">:</span><span class="mi">4000</span><span class="o">/</span> <span class="p">(</span><span class="n">Press</span> <span class="n">CTRL</span><span class="o">+</span><span class="n">C</span> <span class="n">to</span> <span class="n">quit</span><span class="p">)</span>
</pre></div>
</div>
<p>使用浏览器打开 <a class="reference external" href="http://localhost:4000/">http://localhost:4000/</a> 看到以下信息，说明</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Hello, World!
</pre></div>
</div>
<p><strong>什么是Flask</strong></p>
<p>Flask is a lightweight WSGI web application framework.
Flask是一个轻量级的web应用框架，它是跑在web服务器中的一个应用。Flask底层就是封装的Werkzeug。
使用Flask开发一个web应用非常简单</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;Hello, World!&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>很简单吧。
接下来我们看看Flask应用的启动流程。</p>
<p><strong>启动流程</strong></p>
<p>从项目地址 github.com/pallets/fla… 中把源码clone下来，然后切换到0.1版本的tag。为何要使用0.1版本呢？因为这个是作者最开始写的版本，代码量应该是最少的，而且可以很容易看到作者整体编码思路。
下面就从最简单的Demo开始看看Flask是如何启动的。我们知道程序启动是执行了以下方法。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
<span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>而</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
</pre></div>
</div>
<p>打开Flask源码中的__init__方法</p>
<p><strong>Flask.init()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">):</span>
<span class="c1">#: 是否打开debug模式</span>
<span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="kc">False</span>

<span class="c1">#: 包名或模块名</span>
<span class="bp">self</span><span class="o">.</span><span class="n">package_name</span> <span class="o">=</span> <span class="n">package_name</span>

<span class="c1">#: 获取app所在目录</span>
<span class="bp">self</span><span class="o">.</span><span class="n">root_path</span> <span class="o">=</span> <span class="n">_get_package_path</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>

<span class="c1">#: 存储视图函数的字典，键为函数名称，值为函数对象，使用@route装饰器进行注册</span>
<span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#: 存储错误处理的字典.  键为error code, 值为处理错误的函数，使用errorhandler装饰器进行注册</span>
<span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span> <span class="o">=</span> <span class="p">{}</span>

<span class="c1">#: 处理请求前执行的函数列表，使用before_request装饰器进行注册</span>
<span class="bp">self</span><span class="o">.</span><span class="n">before_request_funcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#: 处理请求前执行的函数列表，使用after_request装饰器进行注册</span>
<span class="bp">self</span><span class="o">.</span><span class="n">after_request_funcs</span> <span class="o">=</span> <span class="p">[]</span>

<span class="c1">#: 模版上下文</span>
<span class="bp">self</span><span class="o">.</span><span class="n">template_context_processors</span> <span class="o">=</span> <span class="p">[</span><span class="n">_default_template_ctx_processor</span><span class="p">]</span>
<span class="c1">#: url 映射</span>
<span class="bp">self</span><span class="o">.</span><span class="n">url_map</span> <span class="o">=</span> <span class="n">Map</span><span class="p">()</span>

<span class="c1">#: 静态文件</span>
<span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">static_path</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">static_path</span> <span class="o">+</span> <span class="s1">&#39;/&lt;filename&gt;&#39;</span><span class="p">,</span>
                          <span class="n">build_only</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">endpoint</span><span class="o">=</span><span class="s1">&#39;static&#39;</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">pkg_resources</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">target</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;static&#39;</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span> <span class="o">=</span> <span class="n">SharedDataMiddleware</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">wsgi_app</span><span class="p">,</span> <span class="p">{</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">static_path</span><span class="p">:</span> <span class="n">target</span>
    <span class="p">})</span>

<span class="c1">#: 初始化 Jinja2 模版环境.</span>
<span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_jinja_loader</span><span class="p">(),</span>
                             <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">jinja_options</span><span class="p">)</span>
<span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
    <span class="n">url_for</span><span class="o">=</span><span class="n">url_for</span><span class="p">,</span>
    <span class="n">get_flashed_messages</span><span class="o">=</span><span class="n">get_flashed_messages</span>
<span class="p">)</span>
</pre></div>
</div>
<p>在Flask的构造函数中进行了各种初始化操作。
然后就是执行app.run()方法</p>
<p><strong>app.run()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">host</span><span class="o">=</span><span class="s1">&#39;localhost&#39;</span><span class="p">,</span> <span class="n">port</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;启动本地开发服务器.  如果debug设置为True，那么会自动检查代码是否改动，有改动则会自动执行部署</span>
<span class="sd">    :param host: 监听的IP地址. 如果设置为 ``&#39;0.0.0.0&#39;``就可以进行外部访问</span>
<span class="sd">    :param port: 端口，默认5000</span>
<span class="sd">    :param options: 这个参数主要是对应run_simple中需要的参数</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">werkzeug.serving</span> <span class="k">import</span> <span class="n">run_simple</span>
    <span class="k">if</span> <span class="s1">&#39;debug&#39;</span> <span class="ow">in</span> <span class="n">options</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="o">=</span> <span class="n">options</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s1">&#39;debug&#39;</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_reloader&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;use_debugger&#39;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">run_simple</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="bp">self</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
</pre></div>
</div>
<p>run很简洁，主要是调用了werkzeug.serving中的run_simple方法。
再打开run_simple的源码</p>
<p><strong>rum_simple()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">run_simple</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">use_reloader</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">use_debugger</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">use_evalex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
               <span class="n">extra_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">reloader_interval</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
               <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">request_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">static_files</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
               <span class="n">passthrough_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="c1"># 这方法还是比较短的，但是注释写得很详细，由于篇幅问题，就把源码中的注释省略了</span>
    <span class="k">if</span> <span class="n">use_debugger</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">werkzeug.debug</span> <span class="k">import</span> <span class="n">DebuggedApplication</span>
        <span class="n">application</span> <span class="o">=</span> <span class="n">DebuggedApplication</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">use_evalex</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">static_files</span><span class="p">:</span>
        <span class="kn">from</span> <span class="nn">werkzeug.wsgi</span> <span class="k">import</span> <span class="n">SharedDataMiddleware</span>
        <span class="n">application</span> <span class="o">=</span> <span class="n">SharedDataMiddleware</span><span class="p">(</span><span class="n">application</span><span class="p">,</span> <span class="n">static_files</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">inner</span><span class="p">():</span>
        <span class="n">make_server</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">threaded</span><span class="p">,</span>
                    <span class="n">processes</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span>
                    <span class="n">passthrough_errors</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">environ</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s1">&#39;WERKZEUG_RUN_MAIN&#39;</span><span class="p">)</span> <span class="o">!=</span> <span class="s1">&#39;true&#39;</span><span class="p">:</span>
        <span class="n">display_hostname</span> <span class="o">=</span> <span class="n">hostname</span> <span class="o">!=</span> <span class="s1">&#39;*&#39;</span> <span class="ow">and</span> <span class="n">hostname</span> <span class="ow">or</span> <span class="s1">&#39;localhost&#39;</span>
        <span class="k">if</span> <span class="s1">&#39;:&#39;</span> <span class="ow">in</span> <span class="n">display_hostname</span><span class="p">:</span>
            <span class="n">display_hostname</span> <span class="o">=</span> <span class="s1">&#39;[</span><span class="si">%s</span><span class="s1">]&#39;</span> <span class="o">%</span> <span class="n">display_hostname</span>
        <span class="n">_log</span><span class="p">(</span><span class="s1">&#39;info&#39;</span><span class="p">,</span> <span class="s1">&#39; * Running on </span><span class="si">%s</span><span class="s1">://</span><span class="si">%s</span><span class="s1">:</span><span class="si">%d</span><span class="s1">/&#39;</span><span class="p">,</span> <span class="n">ssl_context</span> <span class="ow">is</span> <span class="kc">None</span>
             <span class="ow">and</span> <span class="s1">&#39;http&#39;</span> <span class="ow">or</span> <span class="s1">&#39;https&#39;</span><span class="p">,</span> <span class="n">display_hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">use_reloader</span><span class="p">:</span>
        <span class="c1"># Create and destroy a socket so that any exceptions are raised before</span>
        <span class="c1"># we spawn a separate Python interpreter and lose this ability.</span>
        <span class="n">test_socket</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
        <span class="n">test_socket</span><span class="o">.</span><span class="n">setsockopt</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">SOL_SOCKET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SO_REUSEADDR</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
        <span class="n">test_socket</span><span class="o">.</span><span class="n">bind</span><span class="p">((</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">))</span>
        <span class="n">test_socket</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="n">run_with_reloader</span><span class="p">(</span><span class="n">inner</span><span class="p">,</span> <span class="n">extra_files</span><span class="p">,</span> <span class="n">reloader_interval</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">inner</span><span class="p">()</span>
</pre></div>
</div>
<p>在rum_simple方法中还定义一个嵌套方法inner()，这个是方法的核心部分。</p>
<p><strong>inner()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">inner</span><span class="p">():</span>
    <span class="n">make_server</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">application</span><span class="p">,</span> <span class="n">threaded</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span> <span class="n">passthrough_errors</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>在inner()方法里面，调用make_server(…).serve_forever()启动了服务。</p>
<p><strong>make_server()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">make_server</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">threaded</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">processes</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>
            <span class="n">request_handler</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">passthrough_errors</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
            <span class="n">ssl_context</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="sd">&quot;&quot;&quot;Create a new server instance that is either threaded, or forks</span>
<span class="sd">or just processes one request after another.</span>
<span class="sd">&quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">threaded</span> <span class="ow">and</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;cannot have a multithreaded and &quot;</span>
                         <span class="s2">&quot;multi process server.&quot;</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">threaded</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ThreadedWSGIServer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span>
                                  <span class="n">passthrough_errors</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span>
    <span class="k">elif</span> <span class="n">processes</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">ForkingWSGIServer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">processes</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span>
                                 <span class="n">passthrough_errors</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">BaseWSGIServer</span><span class="p">(</span><span class="n">host</span><span class="p">,</span> <span class="n">port</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">request_handler</span><span class="p">,</span>
                              <span class="n">passthrough_errors</span><span class="p">,</span> <span class="n">ssl_context</span><span class="p">)</span>
</pre></div>
</div>
<p>在make_server()中会根据线程或者进程的数量创建对应的WSGI服务器。Flask在默认情况下是创建BaseWSGIServer服务器。</p>
<p><strong>BaseWSGIServer、ThreadedWSGIServer、ForkingWSGIServer</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">BaseWSGIServer</span><span class="p">(</span><span class="n">HTTPServer</span><span class="p">,</span> <span class="nb">object</span><span class="p">):</span>
<span class="o">...</span>

<span class="k">class</span> <span class="nc">ThreadedWSGIServer</span><span class="p">(</span><span class="n">ThreadingMixIn</span><span class="p">,</span> <span class="n">BaseWSGIServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WSGI server that does threading.&quot;&quot;&quot;</span>
    <span class="o">...</span>

<span class="k">class</span> <span class="nc">ForkingWSGIServer</span><span class="p">(</span><span class="n">ForkingMixIn</span><span class="p">,</span> <span class="n">BaseWSGIServer</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;A WSGI server that does forking.&quot;&quot;&quot;</span>
    <span class="o">...</span>
</pre></div>
</div>
<p>可以看出他们之前的继承关系如下</p>
<img alt="../_images/BaseWSGIServer、ThreadedWSGIServer、ForkingWSGIServer继承关系.png" src="../_images/BaseWSGIServer、ThreadedWSGIServer、ForkingWSGIServer继承关系.png" />
<p>打开BaseWSGIServer的start_server()方法</p>
<p><strong>start_server()</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">HTTPServer</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">KeyboardInterrupt</span><span class="p">:</span>
        <span class="k">pass</span>
</pre></div>
</div>
<p>可以看到最终是使用HTTPServer中的启动服务的方法。而HTTPServer是Python标准类库中的接口。
HTTPServer是socketserver.TCPServer的子类</p>
<p><strong>socketserver.TCPServer</strong></p>
<p>如果要使用Python中类库启动一个http server，则类似代码应该是这样的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">http.server</span>
<span class="kn">import</span> <span class="nn">socketserver</span>

<span class="n">PORT</span> <span class="o">=</span> <span class="mi">8000</span>

<span class="n">Handler</span> <span class="o">=</span> <span class="n">http</span><span class="o">.</span><span class="n">server</span><span class="o">.</span><span class="n">SimpleHTTPRequestHandler</span>

<span class="k">with</span> <span class="n">socketserver</span><span class="o">.</span><span class="n">TCPServer</span><span class="p">((</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">),</span> <span class="n">Handler</span><span class="p">)</span> <span class="k">as</span> <span class="n">httpd</span><span class="p">:</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;serving at port&quot;</span><span class="p">,</span> <span class="n">PORT</span><span class="p">)</span>
    <span class="n">httpd</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">()</span>
</pre></div>
</div>
<p>至此，整个服务的启动就到这里就启动起来了。
这个过程的调用流程为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">graph</span> <span class="n">TD</span>

<span class="n">A</span><span class="p">[</span><span class="n">Flask</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">B</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">]</span>
<span class="n">B</span><span class="p">[</span><span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">C</span><span class="p">[</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">run_simple</span><span class="p">]</span>
<span class="n">C</span><span class="p">[</span><span class="n">werkzeug</span><span class="o">.</span><span class="n">run_simple</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">D</span><span class="p">[</span><span class="n">BaseWSGIServer</span><span class="p">]</span>
<span class="n">D</span><span class="p">[</span><span class="n">BaseWSGIServer</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">E</span><span class="p">[</span><span class="n">HTTPServer</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">]</span>
<span class="n">E</span><span class="p">[</span><span class="n">HTTPServer</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">]</span><span class="o">--&gt;</span><span class="n">F</span><span class="p">[</span><span class="n">TCPServer</span><span class="o">.</span><span class="n">serve_forever</span><span class="p">]</span>
</pre></div>
</div>
<p><strong>总结一下</strong></p>
<p>WSGI是WEB服务器与WEB应用之间交互的接口规范。werkzeug是实现了这一个规范的函数库，而Flask框架是基于
werkzeug来实现的。 我们从Flask.run()方法启动服务开始，追踪了整个服务启动的流程。</p>
</div>
<div class="section" id="id43">
<h3>Flask源码解读(二) 路由原理<a class="headerlink" href="#id43" title="永久链接至标题">¶</a></h3>
<p><strong>路由原理</strong></p>
<p>首先看下Flask的简易用法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">Flask</span>

<span class="n">app</span> <span class="o">=</span> <span class="n">Flask</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">():</span>
    <span class="k">return</span> <span class="n">f</span><span class="s1">&#39;Hello, World!&#39;</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">app</span><span class="o">.</span><span class="n">run</span><span class="p">()</span>
</pre></div>
</div>
<p>在Flask中是使用&#64;app.route这个装饰器来实现url和方法之间的映射的。</p>
<p><strong>Flask.route</strong></p>
<p>打开route方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">route</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;这个方法的注释非常详细，为了避免代码篇幅过长，这里省略注释&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="nf">decorator</span><span class="p">(</span><span class="n">f</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="n">f</span><span class="o">.</span><span class="vm">__name__</span><span class="p">]</span> <span class="o">=</span> <span class="n">f</span>
        <span class="k">return</span> <span class="n">f</span>

    <span class="k">return</span> <span class="n">decorator</span>
</pre></div>
</div>
<p>在route方法中有两个参数rule和options。rule是url规则，options参数主要是werkzeug.routing.Rule类使用。
方法内部还定义decorator方法，将url路径规则，和方法名称对应关系保存起来，然后将函数方法名与函数对象也对
应的保存到一个字典中。</p>
<p><strong>Flask.add_url_rule</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add_url_rule</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rule</span><span class="p">,</span> <span class="n">endpoint</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">):</span>
    <span class="n">options</span><span class="p">[</span><span class="s1">&#39;endpoint&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">endpoint</span>
    <span class="n">options</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="s1">&#39;methods&#39;</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;GET&#39;</span><span class="p">,))</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">Rule</span><span class="p">(</span><span class="n">rule</span><span class="p">,</span> <span class="o">**</span><span class="n">options</span><span class="p">))</span>
</pre></div>
</div>
<p>这个方法的注释也是很详细的，大概的意思如果定义了一个方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">pass</span>
</pre></div>
</div>
<p>等价于</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">index</span><span class="p">():</span>
    <span class="k">pass</span>
<span class="n">app</span><span class="o">.</span><span class="n">add_url_rule</span><span class="p">(</span><span class="s1">&#39;index&#39;</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">)</span>
<span class="n">app</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="s1">&#39;index&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">index</span>
</pre></div>
</div>
<p>最后调用url_map.add方法将rule和option构造成Rule添加到一个Map对象中。</p>
<p><strong>Rule</strong></p>
<p>Rule表示url规则，它是在werkzeug函数库中定义的类。
url_map是一个自定义的Map对象。它的目的就是实现url与方法之间映射关系。</p>
<p><strong>Map.add</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">rulefactory</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Add a new rule or factory to the map and bind it.  Requires that the</span>
<span class="sd">    rule is not bound to another map.</span>

<span class="sd">    :param rulefactory: a :class:`Rule` or :class:`RuleFactory`</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">for</span> <span class="n">rule</span> <span class="ow">in</span> <span class="n">rulefactory</span><span class="o">.</span><span class="n">get_rules</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">rule</span><span class="o">.</span><span class="n">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_rules_by_endpoint</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">rule</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">rule</span><span class="p">)</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_remap</span> <span class="o">=</span> <span class="kc">True</span>
</pre></div>
</div>
<p>在add方法中就调用了rule中的bind方法，这里才是真正实现绑定的逻辑。</p>
<p><strong>Rule.bind</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">bind</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="nb">map</span><span class="p">,</span> <span class="n">rebind</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Bind the url to a map and create a regular expression based on</span>
<span class="sd">    the information from the rule itself and the defaults from the map.</span>

<span class="sd">    :internal:</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">rebind</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s1">&#39;url rule </span><span class="si">%r</span><span class="s1"> already bound to map </span><span class="si">%r</span><span class="s1">&#39;</span> <span class="o">%</span>
                           <span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">map</span><span class="p">))</span>
    <span class="c1"># 将url与map对应起来，即将map保存在rule对象自身的map属性上</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">map</span> <span class="o">=</span> <span class="nb">map</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_slashes</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">strict_slashes</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">strict_slashes</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">=</span> <span class="nb">map</span><span class="o">.</span><span class="n">default_subdomain</span>

    <span class="n">rule</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subdomain</span> <span class="o">+</span> <span class="s1">&#39;|&#39;</span> <span class="o">+</span> <span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">is_leaf</span> <span class="ow">and</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span> <span class="ow">or</span> <span class="bp">self</span><span class="o">.</span><span class="n">rule</span><span class="o">.</span><span class="n">rstrip</span><span class="p">(</span><span class="s1">&#39;/&#39;</span><span class="p">))</span>

    <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_converters</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="n">regex_parts</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">converter</span><span class="p">,</span> <span class="n">arguments</span><span class="p">,</span> <span class="n">variable</span> <span class="ow">in</span> <span class="n">parse_rule</span><span class="p">(</span><span class="n">rule</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">converter</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">regex_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">escape</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="n">variable</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">convobj</span> <span class="o">=</span> <span class="n">get_converter</span><span class="p">(</span><span class="nb">map</span><span class="p">,</span> <span class="n">converter</span><span class="p">,</span> <span class="n">arguments</span><span class="p">)</span>
            <span class="n">regex_parts</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s1">&#39;(?P&lt;</span><span class="si">%s</span><span class="s1">&gt;</span><span class="si">%s</span><span class="s1">)&#39;</span> <span class="o">%</span> <span class="p">(</span><span class="n">variable</span><span class="p">,</span> <span class="n">convobj</span><span class="o">.</span><span class="n">regex</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_converters</span><span class="p">[</span><span class="n">variable</span><span class="p">]</span> <span class="o">=</span> <span class="n">convobj</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">True</span><span class="p">,</span> <span class="n">variable</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_weights</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">convobj</span><span class="o">.</span><span class="n">weight</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">arguments</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">variable</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">convobj</span><span class="o">.</span><span class="n">is_greedy</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">greediness</span> <span class="o">+=</span> <span class="mi">1</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_leaf</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_trace</span><span class="o">.</span><span class="n">append</span><span class="p">((</span><span class="kc">False</span><span class="p">,</span> <span class="s1">&#39;/&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">build_only</span><span class="p">:</span>
        <span class="n">regex</span> <span class="o">=</span> <span class="sa">r</span><span class="s1">&#39;^</span><span class="si">%s%s</span><span class="s1">$&#39;</span> <span class="o">%</span> <span class="p">(</span>
            <span class="sa">u</span><span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">regex_parts</span><span class="p">),</span>
            <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">is_leaf</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">strict_slashes</span><span class="p">)</span> <span class="ow">and</span> \
                <span class="s1">&#39;(?&lt;!/)(?P&lt;__suffix__&gt;/?)&#39;</span> <span class="ow">or</span> <span class="s1">&#39;&#39;</span>
        <span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_regex</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">regex</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">UNICODE</span><span class="p">)</span>
</pre></div>
</div>
<p>在bind方法中的for循环中调用了parse_url方法，这是一个生成器函数，它使用正则进行并yield回一个元组。这个方法的细节还是挺多的，但这里我们抓住主脉络，先把整体流程搞清楚。
在Flask启动时从装饰器route开始就把会把url和响应的函数方法对应起来。
调用逻辑为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Flask</span><span class="o">.</span><span class="n">route</span> <span class="o">-&gt;</span> <span class="n">Flask</span><span class="o">.</span><span class="n">add_url_rule</span> <span class="o">-&gt;</span> <span class="n">Map</span><span class="o">.</span><span class="n">add</span> <span class="o">-&gt;</span> <span class="n">Rule</span><span class="o">.</span><span class="n">bind</span>
</pre></div>
</div>
<p><strong>响应请求</strong></p>
<p>当服务启动之后，Flask会默认开启一个Web服务器，便于开发调试，而实际环境中可能会使用nginx+gunicorn等工具进行部署。由于部署不是本节主题，我们还是专注于客户端请求是如何响应的。</p>
<p>在上一篇我们知道Flask通过Werkzeug函数库中的run_simple方法将服务启动了。
当客户端发送请求时这个方法会被执行</p>
<p><strong>Flask.wsgi_app</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The actual WSGI application.  This is not implemented in</span>
<span class="sd">    `__call__` so that middlewares can be applied:</span>

<span class="sd">        app.wsgi_app = MyMiddleware(app.wsgi_app)</span>

<span class="sd">    :param environ: a WSGI environment</span>
<span class="sd">    :param start_response: a callable accepting a status code, a list of headers and an optional</span>
<span class="sd">    exception context to start the response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_request</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>environ 是Web服务器传递过来的参数，request_context(environ)会创建一个请求上下文实例，通过预处理preprocess_request之后就会进入分发请求dispatch_request，然后是执行响应make_response和process_response，最后返回response。
这里我们重点关注dispatch_request。</p>
<p><strong>Flask.dispatch_request</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">dispatch_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Does the request dispatching.  Matches the URL and returns the</span>
<span class="sd">    return value of the view or error handler.  This does not have to</span>
<span class="sd">    be a response object.  In order to convert the return value to a</span>
<span class="sd">    proper response object, call :func:`make_response`.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">endpoint</span><span class="p">,</span> <span class="n">values</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">match_request</span><span class="p">()</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">view_functions</span><span class="p">[</span><span class="n">endpoint</span><span class="p">](</span><span class="o">**</span><span class="n">values</span><span class="p">)</span>
    <span class="k">except</span> <span class="n">HTTPException</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">e</span><span class="o">.</span><span class="n">code</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">e</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="n">handler</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">error_handlers</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="mi">500</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">debug</span> <span class="ow">or</span> <span class="n">handler</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span>
        <span class="k">return</span> <span class="n">handler</span><span class="p">(</span><span class="n">e</span><span class="p">)</span>
</pre></div>
</div>
<p>这个方法的核心就是match_request，通过匹配客户端请求的url规则找到对应函数方法。</p>
<p><strong>Flask.match_request</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">match_request</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Matches the current request against the URL map and also</span>
<span class="sd">    stores the endpoint and view arguments on the request object</span>
<span class="sd">    is successful, otherwise the exception is stored.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">rv</span> <span class="o">=</span> <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">url_adapter</span><span class="o">.</span><span class="n">match</span><span class="p">()</span>
    <span class="n">request</span><span class="o">.</span><span class="n">endpoint</span><span class="p">,</span> <span class="n">request</span><span class="o">.</span><span class="n">view_args</span> <span class="o">=</span> <span class="n">rv</span>
    <span class="k">return</span> <span class="n">rv</span>
</pre></div>
</div>
<p>匹配完成后就会调用self.view_functions[endpoint](**values)来执行对应函数方法，并返回函数的返回值。
如果上述dispatch_request没有匹配到url规则，则会执行error_handlers字典中找到对应的错误码执行handler方法。
至此url路由规则匹配过程就完成了。</p>
<p><strong>总结一下</strong></p>
<p>在Flask启动后会把route装饰器解析后，把url规则与函数方法进行对应保存。 在客户端请求时，Flask.wsgi_app方法会被执行，
并开始匹配url找到对应的方法，执行后将结果返回。</p>
</div>
<div class="section" id="id44">
<h3>Flask源码解读(三) 模版渲染过程<a class="headerlink" href="#id44" title="永久链接至标题">¶</a></h3>
<p><strong>使用模板</strong></p>
<p>首先看一个来自官方文档使用模板渲染的例子</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">flask</span> <span class="k">import</span> <span class="n">render_template</span>

<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&#39;</span><span class="p">)</span>
<span class="nd">@app</span><span class="o">.</span><span class="n">route</span><span class="p">(</span><span class="s1">&#39;/hello/&lt;name&gt;&#39;</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">hello</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">render_template</span><span class="p">(</span><span class="s1">&#39;hello.html&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">)</span>
</pre></div>
</div>
<p>在项目目录下需要有一个templates目录，并创建了一个hello.html文件</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="n">templates</span>
    <span class="o">/</span><span class="n">hello</span><span class="o">.</span><span class="n">html</span>
</pre></div>
</div>
<p>hello.html的内容为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!doctype html&gt;
&lt;title&gt;Hello from Flask&lt;/title&gt;
{% if name %}
  &lt;h1&gt;Hello {{ name }}!&lt;/h1&gt;
{% else %}
  &lt;h1&gt;Hello, World!&lt;/h1&gt;
{% endif %}
</pre></div>
</div>
<p>这个模板中name是参数，通过调用render_template方法就可以根据参数实现html模板文件的渲染。</p>
<p><strong>Flask.render_template</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Renders a template from the template folder with the given</span>
<span class="sd">    context.</span>

<span class="sd">    :param template_name: the name of the template to be rendered</span>
<span class="sd">    :param context: the variables that should be available in the</span>
<span class="sd">                    context of the template.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">current_app</span><span class="o">.</span><span class="n">update_template_context</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>方法的注释很清楚，从templates文件夹中找到名称为template_name的文件进行渲染。其中current_app是通过以下语句初始化</p>
<p>_request_ctx_stack = LocalStack()
current_app = LocalProxy(lambda: _request_ctx_stack.top.app)</p>
<p>LocalStack就是一个栈的实现类。而_request_ctx_stack是在Flask.request_context()方法中将当前的上下文实例push到栈里面的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">request_context</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates a request context from the given environment and binds</span>
<span class="sd">    it to the current context.  This must be used in combination with</span>
<span class="sd">    the `with` statement because the request is only bound to the</span>
<span class="sd">    current context for the duration of the `with` block.</span>

<span class="sd">    Example usage::</span>

<span class="sd">        with app.request_context(environ):</span>
<span class="sd">            do_something_with(request)</span>

<span class="sd">    :params environ: a WSGI environment</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">_RequestContext</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">)</span>
</pre></div>
</div>
<p>_RequestContext类实现了上下文管理器协议，它可以在with语句中使用</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">_RequestContext</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The request context contains all request relevant information.  It is</span>
<span class="sd">    created at the beginning of the request and pushed to the</span>
<span class="sd">    `_request_ctx_stack` and removed at the end of it.  It will create the</span>
<span class="sd">    URL adapter and request object for the WSGI environment provided.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">app</span><span class="p">,</span> <span class="n">environ</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">app</span> <span class="o">=</span> <span class="n">app</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">url_adapter</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">url_map</span><span class="o">.</span><span class="n">bind_to_environ</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">request</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">request_class</span><span class="p">(</span><span class="n">environ</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">session</span> <span class="o">=</span> <span class="n">app</span><span class="o">.</span><span class="n">open_session</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">request</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">g</span> <span class="o">=</span> <span class="n">_RequestGlobals</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">flashes</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">def</span> <span class="nf">__enter__</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">push</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">__exit__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">exc_type</span><span class="p">,</span> <span class="n">exc_value</span><span class="p">,</span> <span class="n">tb</span><span class="p">):</span>
        <span class="c1"># do not pop the request stack if we are in debug mode and an</span>
        <span class="c1"># exception happened.  This will allow the debugger to still</span>
        <span class="c1"># access the request object in the interactive shell.</span>
        <span class="k">if</span> <span class="n">tb</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">app</span><span class="o">.</span><span class="n">debug</span><span class="p">:</span>
            <span class="n">_request_ctx_stack</span><span class="o">.</span><span class="n">pop</span><span class="p">()</span>
</pre></div>
</div>
<p>执行__enter__()时操作push，退出with语句时就执行pop操作。
回到request_context()方法，它是在wsgi_app()中被调用的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">wsgi_app</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;The actual WSGI application.  This is not implemented in</span>
<span class="sd">    `__call__` so that middlewares can be applied:</span>

<span class="sd">        app.wsgi_app = MyMiddleware(app.wsgi_app)</span>

<span class="sd">    :param environ: a WSGI environment</span>
<span class="sd">    :param start_response: a callable accepting a status code,</span>
<span class="sd">                           a list of headers and an optional</span>
<span class="sd">                           exception context to start the response</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">request_context</span><span class="p">(</span><span class="n">environ</span><span class="p">):</span>
        <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess_request</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">rv</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">rv</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">dispatch_request</span><span class="p">()</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_response</span><span class="p">(</span><span class="n">rv</span><span class="p">)</span>
        <span class="n">response</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">process_response</span><span class="p">(</span><span class="n">response</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">response</span><span class="p">(</span><span class="n">environ</span><span class="p">,</span> <span class="n">start_response</span><span class="p">)</span>
</pre></div>
</div>
<p>从路由原理文章的分析知道，wsgi_app()在服务端接收到客户端请求时就会执行。 所以当请求来临时，就会把当
前Flask实例的请求上下文实例保存到栈实例_request_ctx_stack中；请求处理后，就从栈里面弹出当前请求的
上下文实例。LocalProxy是一个代理类，它的构造函数传递了一个lambda表达式：
lambda: _request_ctx_stack.top.app。 这个操作就把当前的上下文实例通过LocalProxy进行了封装，
即current_app是当前Flask实例的上下文的代理。 所以当current_app.jinja_env这个语句其实就是访问
Flask的实例属性jinja_env，这个属性是在Flask的构造函数中进行初始化的。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">class</span> <span class="nc">Flask</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c1">#: 源码太长了省略</span>
    <span class="c1">#: options that are passed directly to the Jinja2 environment</span>
    <span class="n">jinja_options</span> <span class="o">=</span> <span class="nb">dict</span><span class="p">(</span>
        <span class="n">autoescape</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
        <span class="n">extensions</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;jinja2.ext.autoescape&#39;</span><span class="p">,</span> <span class="s1">&#39;jinja2.ext.with_&#39;</span><span class="p">]</span>
    <span class="p">)</span>

    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">package_name</span><span class="p">):</span>
        <span class="o">...</span>
        <span class="c1">#: 源码太长省略部分源码</span>
        <span class="c1">#: the Jinja2 environment.  It is created from the</span>
        <span class="c1">#: :attr:`jinja_options` and the loader that is returned</span>
        <span class="c1">#: by the :meth:`create_jinja_loader` function.</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span> <span class="o">=</span> <span class="n">Environment</span><span class="p">(</span><span class="n">loader</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">create_jinja_loader</span><span class="p">(),</span>
                                     <span class="o">**</span><span class="bp">self</span><span class="o">.</span><span class="n">jinja_options</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">globals</span><span class="o">.</span><span class="n">update</span><span class="p">(</span>
            <span class="n">url_for</span><span class="o">=</span><span class="n">url_for</span><span class="p">,</span>
            <span class="n">get_flashed_messages</span><span class="o">=</span><span class="n">get_flashed_messages</span>
        <span class="p">)</span>
</pre></div>
</div>
<p>jinja_env是一个Environment实例。这个是jinja模板引擎提供的类，Flask框架的模板渲染就是通过jinja来实现的。 Environment需要一个loader，是通过以下方法获取的</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">create_jinja_loader</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Creates the Jinja loader.  By default just a package loader for</span>
<span class="sd">    the configured package is returned that looks up templates in the</span>
<span class="sd">    `templates` folder.  To add other loaders it&#39;s possible to</span>
<span class="sd">    override this method.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">pkg_resources</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">FileSystemLoader</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">root_path</span><span class="p">,</span> <span class="s1">&#39;templates&#39;</span><span class="p">))</span>
    <span class="k">return</span> <span class="n">PackageLoader</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">package_name</span><span class="p">)</span>
</pre></div>
</div>
<p>默认情况下是从templates目录下构造一个FileSystemLoader的实例，这个类的作用就是从文件系统中加载模板文件的。</p>
<p><strong>Environment.get_template</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@internalcode</span>
<span class="k">def</span> <span class="nf">get_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Load a template from the loader.  If a loader is configured this</span>
<span class="sd">    method ask the loader for the template and returns a :class:`Template`.</span>
<span class="sd">    If the `parent` parameter is not `None`, :meth:`join_path` is called</span>
<span class="sd">    to get the real template name before loading.</span>

<span class="sd">    The `globals` parameter can be used to provide template wide globals.</span>
<span class="sd">    These variables are available in the context at render time.</span>

<span class="sd">    If the template does not exist a :exc:`TemplateNotFound` exception is</span>
<span class="sd">    raised.</span>

<span class="sd">    .. versionchanged:: 2.4</span>
<span class="sd">       If `name` is a :class:`Template` object it is returned from the</span>
<span class="sd">       function unchanged.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">Template</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">name</span>
    <span class="k">if</span> <span class="n">parent</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">join_path</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="n">parent</span><span class="p">)</span>
    <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_load_template</span><span class="p">(</span><span class="n">name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_globals</span><span class="p">(</span><span class="nb">globals</span><span class="p">))</span>
</pre></div>
</div>
<p>get_template()方法内部调用了_load_template()方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@internalcode</span>
<span class="k">def</span> <span class="nf">_load_template</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">):</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="s1">&#39;no loader for this environment specified&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">template</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="p">(</span><span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">auto_reload</span> <span class="ow">or</span> \
                                     <span class="n">template</span><span class="o">.</span><span class="n">is_up_to_date</span><span class="p">):</span>
            <span class="k">return</span> <span class="n">template</span>
    <span class="n">template</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">loader</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">globals</span><span class="p">)</span>
    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">cache</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cache</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">template</span>
    <span class="k">return</span> <span class="n">template</span>
</pre></div>
</div>
<p>_load_template()方法首先会检查是否有缓存，如果缓存可用就使用缓存；缓存不可用就使用loader加载模板，
这个loader就是前面提到的FileSystemLoader的实例（默认情况下）。</p>
<p><strong>BaseLoader.load</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="nd">@internalcode</span>
<span class="k">def</span> <span class="nf">load</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">environment</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="nb">globals</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="c1"># 省略部分源码</span>
    <span class="k">return</span> <span class="n">environment</span><span class="o">.</span><span class="n">template_class</span><span class="o">.</span><span class="n">from_code</span><span class="p">(</span><span class="n">environment</span><span class="p">,</span> <span class="n">code</span><span class="p">,</span> <span class="nb">globals</span><span class="p">,</span> <span class="n">uptodate</span><span class="p">)</span>
</pre></div>
</div>
<p>BaseLoader是FileSystemLoader的基类。这个load方法实现了模板的编译、加载等逻辑。最后是使用
environment.template_class.from_code()方法。其中template_class是Template类，它代表编译后的模板
对象。 from_code是Template类的静态方法，可以用来创建一个Template实例。当load方法返回时，就得到了一个
Template对象。 最后回到render_template方法</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">render_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">,</span> <span class="o">**</span><span class="n">context</span><span class="p">):</span>
    <span class="o">...</span>
    <span class="k">return</span> <span class="n">current_app</span><span class="o">.</span><span class="n">jinja_env</span><span class="o">.</span><span class="n">get_template</span><span class="p">(</span><span class="n">template_name</span><span class="p">)</span><span class="o">.</span><span class="n">render</span><span class="p">(</span><span class="n">context</span><span class="p">)</span>
</pre></div>
</div>
<p>执行了Template对象的render()方法。</p>
<p><strong>Template.render</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">render</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="o">*</span><span class="n">args</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;This function accepts either a dict or some keyword arguments which</span>
<span class="sd">    will then be the context the template is evaluated in.  The return</span>
<span class="sd">    value will be the rendered template.</span>

<span class="sd">    :param context: the function accepts the same arguments as the</span>
<span class="sd">                    :class:`dict` constructor.</span>
<span class="sd">    :return: the rendered template as string</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">ns</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">default_context</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">args</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">utils</span><span class="o">.</span><span class="n">MultiDict</span><span class="p">):</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">args</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">to_dict</span><span class="p">(</span><span class="n">flat</span><span class="o">=</span><span class="kc">True</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="nb">dict</span><span class="p">(</span><span class="o">*</span><span class="n">args</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">kwargs</span><span class="p">:</span>
        <span class="n">ns</span><span class="o">.</span><span class="n">update</span><span class="p">(</span><span class="n">kwargs</span><span class="p">)</span>
    <span class="n">context</span> <span class="o">=</span> <span class="n">Context</span><span class="p">(</span><span class="n">ns</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">charset</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">errors</span><span class="p">)</span>
    <span class="n">exec</span> <span class="bp">self</span><span class="o">.</span><span class="n">code</span> <span class="ow">in</span> <span class="n">context</span><span class="o">.</span><span class="n">runtime</span><span class="p">,</span> <span class="n">context</span>
    <span class="k">return</span> <span class="n">context</span><span class="o">.</span><span class="n">get_value</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">unicode_mode</span><span class="p">)</span>
</pre></div>
</div>
<p>这个方法接收一个dict类型参数，用于给模板传递参数。该方法的**核心是执行exec**函数。exec是Python内置函数，它可以动态的执行Python代码。</p>
<p><strong>总结一下</strong></p>
<p>Flask使用Jinja作为模板引擎。执行路径为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Flask</span><span class="o">.</span><span class="n">render_template</span> <span class="o">=&gt;</span> <span class="n">Environment</span><span class="o">.</span><span class="n">get_template</span> <span class="o">=&gt;</span> <span class="n">Template</span><span class="o">.</span><span class="n">render</span> <span class="o">=&gt;</span> <span class="n">exec</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="id45">
<h2>测试<a class="headerlink" href="#id45" title="永久链接至标题">¶</a></h2>
<div class="section" id="id46">
<h3>单元测试<a class="headerlink" href="#id46" title="永久链接至标题">¶</a></h3>
<div class="section" id="unittest">
<h4>单元测试框架—unittest<a class="headerlink" href="#unittest" title="永久链接至标题">¶</a></h4>
<p><strong>工作原理</strong></p>
<p>核心概念：test case, testsuite, TestLoder,TextTestRunner,TextTestResult, test fixture</p>
<p>TestCase（测试用例）: 所有测试用例的基类，它是软件 测试中最基本的组成单元。一个test case就是一个测试
用例，是一个完整的测试流程，包括测试前环境的搭建setUp，执行测试代码(run)，以及测试后环境的还原(tearDown)。
测试用例是一个完整的测试单元，可以对某一问题进行验证。</p>
<p>TestSuite（测试套件）:多个测试用例test case集合就是TestSuite，TestSuite可以嵌套TestSuite</p>
<p>TestLoder：是用来加载 TestCase到TestSuite中，其中有几个loadTestsFrom_()方法，就是从各个地方寻找TestCase，
创建他们的实例，然后add到TestSuite中，再返回一个TestSuite实例</p>
<p>TextTestRunner：是来执行测试用例的，其中的run（test）会执行TestSuite/TestCase中的run(result)方法。</p>
<p>TextTestResult：测试结果会保存到TextTestResult实例中，包括运行了多少用例，成功与失败多少等信息</p>
<p>TestFixture:又叫测试脚手，测试代码的运行环境，指测试准备前和执行后要做的工作，包括setUp和tearDown方法</p>
<p><strong>测试流程：</strong></p>
<p>1. 写好TestCase：一个class继承unittest.TestCase，就是一个测试测试用例，其中有多个以test开头的方法，那么 每一个这样的，
在load的时候会生成一个TestCase实例。如果一个class中有四个test开头的方法，最后load到suite中时则有四个测试用例</p>
<ol class="arabic simple" start="2">
<li><p>由TestLoder加载TestCase到TestSuite</p></li>
</ol>
<p>3.然后由TextTestRunner来运行TestSuite，运行的结果保存在TextTestResult中。
说明：a:通过命令行或者unittest.main()执行时，main会调用TextTestRunner中的run来执行，或者可以直接通过TextTestRunner来执行用例
b:Runner执行时，默认将结果输出到控制台，我们可以设置其输出到文件，在文件中查看 结果，也可以通过HTMLTestRunner将结果输出到HTML)</p>
<p><strong>unittest实例</strong></p>
<p>1.准备待测方法：</p>
<p>mathfunc.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">add</span><span class="p">(</span><span class="n">a</span><span class="p">,</span><span class="n">b</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">a</span><span class="o">+</span><span class="n">b</span>
</pre></div>
</div>
<p>2.为以上方法写测试：</p>
<p>test_mathfunc.py</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>
<span class="kn">from</span> <span class="nn">mathfunc</span> <span class="k">import</span> <span class="o">*</span>

<span class="k">class</span> <span class="nc">TestMathFunc</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_add</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="n">add</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

<span class="k">if</span> <span class="vm">__name__</span><span class="o">==</span><span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>执行结果说明：</p>
<p>a:每一个用例执行的结果的标识，成功是 .，失败是 F，出错是 E，跳过是 S。测试的执行跟方法的顺序没有关系。</p>
<p>b:每个测试方法均以 test 开头，否则是不被unittest识别的。</p>
<p>c:在unittest.main()中加 verbosity 参数可以控制输出的错误报告的详细程度，默认是 1，如果设为 0，则不
输出每一用例的执行结果；如果设为 2，则输出详细的执行结果。</p>
</div>
</div>
<div class="section" id="id47">
<h3>压力测试<a class="headerlink" href="#id47" title="永久链接至标题">¶</a></h3>
<div class="section" id="ab">
<h4>ab压力测试工具<a class="headerlink" href="#ab" title="永久链接至标题">¶</a></h4>
<p>1.ab压测工具简介</p>
<p>ab是apache自带的压力测试工具。ab非常实用，它不仅可以对apache服务器进行网站访问压力测试，也可以对或其它类型的服务器进行压力测试。比如nginx、tomcat、IIS等。</p>
<p><strong>使用</strong></p>
<p>ab -n 1000 -c 100 <a class="reference external" href="http://www.baidu.com/">http://www.baidu.com/</a></p>
<p>-n 1000 总请求数1000</p>
<p>-c 100 单个时刻并发数100</p>
<p>-k 是否开启长连接</p>
<p><strong>测验结果</strong></p>
<img alt="../_images/ab压测结果示意图.png" src="../_images/ab压测结果示意图.png" />
</div>
<div class="section" id="id48">
<h4>压力测试指标<a class="headerlink" href="#id48" title="永久链接至标题">¶</a></h4>
<p><strong>吞吐率（Requests per second)</strong></p>
<p>概念：服务器并发处理能力的量化描述，单位是reqs/s，指的是某个并发用户数下单位时间内处理的请求数。某个并发用户数下单位时间内能处理的最大请求数，称之为最大吞吐率。</p>
<p>计算公式：总请求数 / 处理完成这些请求数所花费的时间，即</p>
<p>Request per second = Complete requests / Time taken for tests</p>
<p><strong>并发连接数（The number of concurrent connections）</strong></p>
<p>概念：某个时刻服务器所接受的请求数目，简单的讲，就是一个会话。</p>
<p><strong>并发用户数（The number of concurrent users，Concurrency Level）</strong></p>
<p>概念：要注意区分这个概念和并发连接数之间的区别，一个用户可能同时会产生多个会话，也即连接数。</p>
<p><strong>用户平均请求等待时间（Time per request）</strong></p>
<p>计算公式：处理完成所有请求数所花费的时间/ （总请求数 / 并发用户数），即</p>
<p>Time per request = Time taken for tests /（ Complete requests / Concurrency Level）</p>
<p><strong>服务器平均请求等待时间（Time per request: across all concurrent requests）</strong></p>
<p>计算公式：处理完成所有请求数所花费的时间 / 总请求数，即</p>
<p>Time taken for / testsComplete requests</p>
<p>可以看到，它是吞吐率的倒数。</p>
<p>同时，它也=用户平均请求等待时间/并发用户数，即</p>
<p>Time per request / Concurrency Level</p>
</div>
</div>
</div>
<div class="section" id="id49">
<h2>前端<a class="headerlink" href="#id49" title="永久链接至标题">¶</a></h2>
<div class="section" id="h5">
<h3>h5基础知识<a class="headerlink" href="#h5" title="永久链接至标题">¶</a></h3>
<p><strong>设置编码格式</strong></p>
<p>Content-Type：text/json;charset=utf-8</p>
<p><strong>基础标签：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>h1
p
input
img
body
html
br
div
span
table、tr、td
ul ol li
</pre></div>
</div>
<p><strong>h5新增标签：</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">article</span>
<span class="n">header</span>
<span class="n">footer</span>
<span class="n">section</span>
<span class="n">nav</span>
</pre></div>
</div>
<p><strong>块级标签</strong></p>
<p>可以随时设置宽度和高度，独占一行</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span>
<span class="n">p</span>
<span class="n">h1</span>
<span class="n">h2</span>
<span class="n">ul</span>
<span class="n">li</span>
</pre></div>
</div>
<p><strong>行内标签</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">span</span>
<span class="n">a</span>
<span class="n">label</span>
</pre></div>
</div>
<p><strong>行内-块级标签</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">img</span>
<span class="nb">input</span>
<span class="n">textarea</span>
</pre></div>
</div>
</div>
<div class="section" id="css">
<h3>css基础知识<a class="headerlink" href="#css" title="永久链接至标题">¶</a></h3>
<div class="section" id="id50">
<h4>css的三种样式<a class="headerlink" href="#id50" title="永久链接至标题">¶</a></h4>
<p>1.行内样式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>style=“background-color：red;”
</pre></div>
</div>
<p>2.页内样式：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">style</span><span class="o">&gt;</span>
    <span class="n">p</span><span class="p">{</span>
        <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
    <span class="p">}</span>
<span class="o">&lt;/</span><span class="n">style</span><span class="o">&gt;</span>
</pre></div>
</div>
<p>3.外部样式表：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">&lt;</span><span class="n">link</span> <span class="n">rel</span><span class="o">=</span><span class="s2">&quot;stylesheet&quot;</span>  <span class="n">href</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="o">&gt;</span>
</pre></div>
</div>
</div>
<div class="section" id="id51">
<h4>css选择器分类<a class="headerlink" href="#id51" title="永久链接至标题">¶</a></h4>
<p>1.id选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1">#abc{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>2.类选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">.</span><span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>3.并列选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="p">,</span> <span class="o">.</span><span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>4.复合选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="o">.</span><span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>5.后代选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span> <span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>6.直接后代选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="o">&gt;</span><span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>7.相邻兄弟选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="o">+</span><span class="n">abc</span><span class="p">{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>8.属性选择器</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">div</span><span class="p">[</span><span class="n">name</span><span class="o">=</span><span class="s2">&quot;jack&quot;</span><span class="p">]{</span>
    <span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">red</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
</div>
<div class="section" id="id52">
<h4>css伪类<a class="headerlink" href="#id52" title="永久链接至标题">¶</a></h4>
<p><strong>常见</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>:focus 向拥有键盘输入焦点的元素添加样式
:hover 当鼠标悬浮在元素上方时，向元素添加样式
</pre></div>
</div>
</div>
<div class="section" id="id53">
<h4>css伪元素<a class="headerlink" href="#id53" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">:</span><span class="n">before在元素之前添加样式</span>
<span class="p">:</span><span class="n">after在元素之后添加样式</span>
</pre></div>
</div>
</div>
<div class="section" id="id54">
<h4>css选择器的优先级别<a class="headerlink" href="#id54" title="永久链接至标题">¶</a></h4>
<p><strong>css样式遵循的规律</strong></p>
<p>1.相同类型的选择器遵循就近原则，叠加原则</p>
<p>2.不同类型的选择器遵循：
id选择器&gt;类选择器&gt;标签选择器</p>
<p>3.对于选择器，针对性越强，它的优先级就越高。</p>
<p>4.选择器的权值。</p>
<p>（原则：选择器的权值加到一起，大的优先，如果权值相同，后定义的优先）</p>
<p>总结：importtant&gt;内联（style）&gt;id&gt;类&gt;标签&gt;通配符</p>
<p>（1）通配符 （*）权值0（优先级别非常低，性能比较差）</p>
<p>（2）标签 权值1</p>
<p>（3）类  权值10</p>
<blockquote>
<div><p>属性 权值10</p>
<p>伪类 权值10</p>
<p>伪元素 权值10</p>
</div></blockquote>
<p>（4）id 权值 100</p>
<p>（5）important 权值1000</p>
</div>
<div class="section" id="id55">
<h4>修改标签的显示类型<a class="headerlink" href="#id55" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>display：none；    #为隐藏标签
display：block；   #让标签变为块级标签
display：inline;     #让标签变为行内标签
display：inline-block;#让标签变为行内-块级标签
</pre></div>
</div>
</div>
<div class="section" id="id56">
<h4>css属性<a class="headerlink" href="#id56" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="mf">1.</span><span class="n">可继承属性</span>
<span class="mf">2.</span><span class="n">不可继承属性</span>
</pre></div>
</div>
</div>
<div class="section" id="id57">
<h4>css盒子模型<a class="headerlink" href="#id57" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">margin</span>
<span class="n">border</span>
<span class="n">padding</span>
<span class="n">content</span>
</pre></div>
</div>
</div>
<div class="section" id="id58">
<h4>css新增特性<a class="headerlink" href="#id58" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">RGBA透明度</span>
<span class="n">background</span><span class="o">-</span><span class="n">color</span><span class="p">:</span><span class="n">rgba</span><span class="p">(</span><span class="mi">255</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">,</span><span class="mf">0.8</span><span class="p">)</span><span class="n">最后一个参数为透明度</span>

<span class="n">块阴影与圆角阴影</span>
<span class="n">box</span><span class="o">-</span><span class="n">shadow</span>  <span class="n">盒子阴影</span>
<span class="n">text</span><span class="o">-</span><span class="n">shadow</span>  <span class="n">文字阴影</span>

<span class="n">设置圆角</span>
<span class="n">boder</span><span class="o">-</span><span class="n">radius</span>
</pre></div>
</div>
</div>
<div class="section" id="id59">
<h4>css布局<a class="headerlink" href="#id59" title="永久链接至标题">¶</a></h4>
<p>1.默认情况下，所有标签的网页都在标准流布局中
从上到下，从左到右</p>
<p>2.任何一种类型的标签一旦脱离标准流，就会被强制转为行内-块级标签</p>
<p>脱离标准流的方法有</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>float属性
left脱离标准流，浮动到父标签最左边
right脱离标准流，浮动到父标签最右边

position属性
absolute绝对定位，相对于static以外的第一个父标签进行定位
fixed相对于浏览器窗口进行定位
relative相对定位，相对于其父标签进行定位
static
inherit
</pre></div>
</div>
</div>
<div class="section" id="id60">
<h4>标签的居中<a class="headerlink" href="#id60" title="永久链接至标题">¶</a></h4>
<p>1.水平居中</p>
<p>行内标签或者行内-块级标签，让内容居中,需要在父标签中设置text-align:center;</p>
<p>块级标签居中，需要在自身中设置margin：0 auto；</p>
<p>2.垂直居中</p>
<p>所有标签</p>
<p>line-height</p>
</div>
</div>
<div class="section" id="js">
<h3>js打乱数组<a class="headerlink" href="#js" title="永久链接至标题">¶</a></h3>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">arr</span><span class="o">=</span><span class="p">[];</span>
<span class="k">for</span><span class="p">(</span><span class="n">var</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="p">;</span><span class="n">i</span><span class="o">&lt;</span><span class="mi">100</span><span class="p">;</span><span class="n">i</span><span class="o">++</span><span class="p">){</span>
    <span class="n">arr</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">i</span><span class="p">;</span>
<span class="p">}</span>
<span class="n">arr</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">function</span><span class="p">(){</span> <span class="k">return</span> <span class="mf">0.5</span> <span class="o">-</span> <span class="n">Math</span><span class="o">.</span><span class="n">random</span><span class="p">()</span> <span class="p">})</span>
<span class="n">var</span> <span class="nb">str</span><span class="o">=</span><span class="n">arr</span><span class="o">.</span><span class="n">join</span><span class="p">();</span>
<span class="n">alert</span><span class="p">(</span><span class="nb">str</span><span class="p">);</span>
</pre></div>
</div>
</div>
<div class="section" id="id61">
<h3>微信小程序<a class="headerlink" href="#id61" title="永久链接至标题">¶</a></h3>
<div class="section" id="id62">
<h4>用户转发<a class="headerlink" href="#id62" title="永久链接至标题">¶</a></h4>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">//</span><span class="n">用户点击右上角分享</span>

<span class="n">onShareAppMessage</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
  <span class="k">return</span> <span class="p">{</span>
    <span class="n">title</span><span class="p">:</span> <span class="s1">&#39;自定义，一般写小程序的名字&#39;</span><span class="p">,</span>
    <span class="n">path</span><span class="p">:</span> <span class="s1">&#39;这里写你这个页面的路径&#39;</span><span class="p">,</span>
    <span class="n">imageUrl</span><span class="p">:</span><span class="s1">&#39;这个是显示的图片，不写就默认当前页面的截图&#39;</span><span class="p">,</span>
    <span class="n">success</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">Share</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">console</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">Share</span> <span class="o">+</span> <span class="s1">&#39;成功&#39;</span><span class="p">);</span>
      <span class="o">//</span> <span class="n">转发成功</span>
    <span class="p">},</span>
    <span class="n">fail</span><span class="p">:</span> <span class="n">function</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="p">{</span>
      <span class="n">console</span><span class="o">.</span><span class="n">log</span><span class="p">(</span><span class="n">res</span> <span class="o">+</span> <span class="s1">&#39;失败&#39;</span><span class="p">);</span>
      <span class="o">//</span> <span class="n">转发失败</span>
    <span class="p">},</span>
    <span class="n">complete</span><span class="p">:</span><span class="n">function</span><span class="p">(</span><span class="n">res</span><span class="p">){</span>
      <span class="o">//</span> <span class="n">不管成功失败都会执行</span>
    <span class="p">}</span>
  <span class="p">}</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="nginx">
<h2>Nginx<a class="headerlink" href="#nginx" title="永久链接至标题">¶</a></h2>
<div class="section" id="id63">
<h3>Nginx简介<a class="headerlink" href="#id63" title="永久链接至标题">¶</a></h3>
<p>Nginx是lgor Sysoev为俄罗斯访问量第二的rambler.ru站点设计开发的。从2004年发布至今，凭借开源的力量，已经接近成熟与完善。</p>
<p>Nginx功能丰富，可作为HTTP服务器，也可作为反向代理服务器，邮件服务器。支持FastCGI、SSL、Virtual Host、URL Rewrite、Gzip等功能。并且支持很多第三方的模块扩展。</p>
</div>
<div class="section" id="id64">
<h3>Nginx知识点<a class="headerlink" href="#id64" title="永久链接至标题">¶</a></h3>
<div class="section" id="location">
<h4>location优先级<a class="headerlink" href="#location" title="永久链接至标题">¶</a></h4>
<p>location指令的作用是根据用户请求的URI来执行不同的应用，也就是根据用户请求的网站URL进行匹配，匹配成功即进行相关的操作。</p>
<img alt="../_images/location.png" src="../_images/location.png" />
</div>
<div class="section" id="upstream">
<h4>upstream负载均衡<a class="headerlink" href="#upstream" title="永久链接至标题">¶</a></h4>
<p><strong>upstream模块相关说明</strong></p>
<p>1、upstream模块应放于nginx.conf配置的http{}标签内</p>
<p>2、upstream模块默认算法是wrr (权重轮询 weighted round-robin)</p>
<p><strong>一、分配方式</strong></p>
<p>Nginx的upstream支持5种分配方式，下面将会详细介绍，其中前三种为Nginx原生支持的分配方式，后两种为第三方支持的分配方式。</p>
<p>1、轮询</p>
<p>轮询是upstream的默认分配方式，即每个请求按照时间顺序轮流分配到不同的后端服务器，如果某个后端服务器down掉后，能自动剔除。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.103</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>2、weight</p>
<p>轮询的加强版，即可以指定轮询比率，weight和访问几率成正比，主要应用于后端服务器异质的场景下。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span> <span class="n">weight</span><span class="o">=</span><span class="mi">1</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span> <span class="n">weight</span><span class="o">=</span><span class="mi">2</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.103</span> <span class="n">weight</span><span class="o">=</span><span class="mi">3</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>3、ip_hash</p>
<p>每个请求按照访问ip（即Nginx的前置服务器或者客户端IP）的hash结果分配，这样每个访客会固定访问一个后端服务器，可以解决session一致问题。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
    <span class="n">ip_hash</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">:</span><span class="mi">7777</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">:</span><span class="mi">8888</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.103</span><span class="p">:</span><span class="mi">9999</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>注意：</p>
<p>1、当负载调度算法为ip_hash时，后端服务器在负载均衡调度中的状态不能是weight和backup。</p>
<p>2、导致负载不均衡。</p>
<p>4、fair</p>
<p>fair顾名思义，公平地按照后端服务器的响应时间（rt）来分配请求，响应时间短即rt小的后端服务器优先分配请求。如果需要使用这种调度算法，必须下载Nginx的upstr_fair模块。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">upstream</span> <span class="n">backend</span> <span class="p">{</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.101</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.102</span><span class="p">;</span>
    <span class="n">server</span> <span class="mf">192.168</span><span class="o">.</span><span class="mf">1.103</span><span class="p">;</span>
    <span class="n">fair</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>5、url_hash，目前用consistent_hash替代url_hash</p>
<p>与ip_hash类似，但是按照访问url的hash结果来分配请求，使得每个url定向到同一个后端服务器，主要应用于后端服务器为缓存时的场景下。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>upstream backend {
    server 192.168.1.101;
    server 192.168.1.102;
    server 192.168.1.103;
    hash $request_uri;
    hash_method crc32;
}
</pre></div>
</div>
</div>
</div>
<div class="section" id="gzip">
<h3>GZIP调优<a class="headerlink" href="#gzip" title="永久链接至标题">¶</a></h3>
<p>网站加载的速度取决于浏览器必须下载的所有文件的大小。减少要传输的文件的大小可以使网站不仅加载更快，而且对于那些宽带是按量计费的人来说也更友好。</p>
<p>gzip是一种流行的数据压缩程序。您可以使用gzip压缩Nginx实时文件。这些文件在检索时由支持它的浏览器解压缩，好处是web服务器和浏览器之间传输的数据量更小，速度更快。</p>
<p>gzip不一定适用于所有文件的压缩。例如，文本文件压缩得非常好，通常会缩小两倍以上。另一方面，诸如JPEG或PNG文件之类的图像已经按其性质进行压缩，使用gzip压缩很难有好的压缩效果或者甚至没有效果。压缩文件会占用服务器资源，因此最好只压缩那些压缩效果好的文件。</p>
<div class="section" id="nginxgzip">
<h4>Nginx的gzip配置<a class="headerlink" href="#nginxgzip" title="永久链接至标题">¶</a></h4>
<p>要更改Nginx的 gzip配置，请使用nano或者其他您喜欢的编辑器，来打开的Nginx主要配置文件。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">nginx</span><span class="o">/</span><span class="n">nginx</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p>找到gzip设置部分，如下所示：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># `gzip` Settings</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>
<span class="n">gzip_disable</span> <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>

<span class="c1"># gzip_vary on;</span>
<span class="c1"># gzip_proxied any;</span>
<span class="c1"># gzip_comp_level 6;</span>
<span class="c1"># gzip_buffers 16 8k;</span>
<span class="c1"># gzip_http_version 1.1;</span>
<span class="c1"># gzip_types text/plain text/css application/json application/x-javascript text/xml application/xml application/xml+rss text/javascript;</span>
</pre></div>
</div>
<dl class="simple">
<dt>您可以看到默认情况下，指令gzip启用了压缩gzip on，但使用#注释符号注释了几个其他设置。我们将对此部分进行一些更改：</dt><dd><p>·通过取消注释所有注释行来启用其他设置（就是删除#）
·添加gzip_min_length 256;指令，告诉Nginx不要压缩小于256字节的文件。这是非常小的文件，可以不用压缩
·gzip_types是表示压缩的文件类型，还可以添加web字体格式、ioc图标和SVG图像等其他类型文件。</p>
</dd>
</dl>
<p>应用这些更改后，设置部分应如下所示：
/etc/nginx/nginx.conf</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="c1"># `gzip` Settings</span>
<span class="c1">#</span>
<span class="c1">#</span>
<span class="n">gzip</span> <span class="n">on</span><span class="p">;</span>
<span class="n">gzip_disable</span> <span class="s2">&quot;msie6&quot;</span><span class="p">;</span>

<span class="n">gzip_vary</span> <span class="n">on</span><span class="p">;</span>
<span class="n">gzip_proxied</span> <span class="nb">any</span><span class="p">;</span>
<span class="n">gzip_comp_level</span> <span class="mi">6</span><span class="p">;</span>
<span class="n">gzip_buffers</span> <span class="mi">16</span> <span class="mi">8</span><span class="n">k</span><span class="p">;</span>
<span class="n">gzip_http_version</span> <span class="mf">1.1</span><span class="p">;</span>
<span class="n">gzip_min_length</span> <span class="mi">256</span><span class="p">;</span>
<span class="n">gzip_types</span> <span class="n">text</span><span class="o">/</span><span class="n">plain</span> <span class="n">text</span><span class="o">/</span><span class="n">css</span> <span class="n">application</span><span class="o">/</span><span class="n">json</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">javascript</span> <span class="n">text</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span> <span class="n">application</span><span class="o">/</span><span class="n">xml</span><span class="o">+</span><span class="n">rss</span> <span class="n">text</span><span class="o">/</span><span class="n">javascript</span> <span class="n">application</span><span class="o">/</span><span class="n">vnd</span><span class="o">.</span><span class="n">ms</span><span class="o">-</span><span class="n">fontobject</span> <span class="n">application</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">font</span><span class="o">-</span><span class="n">ttf</span> <span class="n">font</span><span class="o">/</span><span class="n">opentype</span> <span class="n">image</span><span class="o">/</span><span class="n">svg</span><span class="o">+</span><span class="n">xml</span> <span class="n">image</span><span class="o">/</span><span class="n">x</span><span class="o">-</span><span class="n">icon</span><span class="p">;</span>
</pre></div>
</div>
<p>保存并关闭文件以退出。</p>
<p>要启用新配置，请重新加载Nginx。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">systemctl</span> <span class="n">reload</span> <span class="n">nginx</span>
</pre></div>
</div>
</div>
</div>
</div>
<div class="section" id="uwsgi">
<h2>Uwsgi<a class="headerlink" href="#uwsgi" title="永久链接至标题">¶</a></h2>
<p><strong>什么是uwsgi</strong></p>
<p>uWSGI是一个Web服务器，它实现了WSGI协议、uwsgi、http等协议。Nginx中HttpUwsgiModule的作用是与uWSGI服务器进行交换。</p>
<p>要注意 WSGI / uwsgi / uWSGI 这三个概念的区分。</p>
<p>WSGI是一种通信协议，</p>
<p>uwsgi同WSGI一样是一种通信协议，全称 Web Server Gateway Interface，或者 Python Web Server Gateway Interface ，是为 Python 语言定义的 Web 服务器和 Web 应用程序或框架之间的一种简单而通用的接口。自从 WSGI 被开发出来以后，许多其它语言中也出现了类似接口。</p>
<p>而uWSGI是实现了uwsgi和WSGI两种协议的Web服务器。</p>
<p>uwsgi协议是一个uWSGI服务器自有的协议，它用于定义传输信息的类型（type of information），每一个uwsgi packet前4byte为传输信息类型描述，它与WSGI相比是两样东西。</p>
<p>为什么有了uWSGI为什么还需要nginx？因为nginx具备优秀的静态内容处理能力，然后将动态内容转发给uWSGI服务器，这样可以达到很好的客户端响应。</p>
<p><strong>下载uwsgi</strong></p>
<p>pip install uwsgi</p>
<p><strong>uwgi启动flask</strong></p>
<p>1.通过命令启动flask</p>
<p>uwsgi –socket 0.0.0.0:5001 –protocol=http -w loginregister:app（loginregister是项目文件，app是flask对象）</p>
<p>2.通过配置文件启动</p>
<p>首先配置好uwsgi.ini配置文件，然后命令行输入 uwsgi –ini uwsgi.ini启动</p>
<p>配置文件如下：</p>
<img alt="../_images/uwsgi启动flask配置文件.png" src="../_images/uwsgi启动flask配置文件.png" />
<p><strong>uwgi启动django</strong></p>
<p>1.通过命令启动Django</p>
<p>uwsgi –http :9090 –wsgi-file foobar.py –master –processes 4 –threads 2</p>
<p>2.通过配置文件启动</p>
<p>首先配置好uwsgi.ini配置文件，然后命令行输入 uwsgi –ini uwsgi.ini启动</p>
<p>配置文件如下：</p>
<img alt="../_images/uwsgi启动Django配置文件.png" src="../_images/uwsgi启动Django配置文件.png" />
</div>
<div class="section" id="supervisor">
<h2>Supervisor<a class="headerlink" href="#supervisor" title="永久链接至标题">¶</a></h2>
<p><strong>安装</strong></p>
<p>pip install supervisor</p>
<p><strong>生成配置文件</strong></p>
<p>echo_supervisord_conf &gt; /etc/supervisor/supervisord.conf</p>
<p><strong>supervisord.conf修改项目配置文件位置</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">;[</span><span class="n">include</span><span class="p">]</span>
<span class="p">;</span><span class="n">files</span> <span class="o">=</span> <span class="n">relative</span><span class="o">/</span><span class="n">directory</span><span class="o">/*.</span><span class="n">ini</span>
</pre></div>
</div>
<p>修改为</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">include</span><span class="p">]</span>
<span class="n">files</span> <span class="o">=</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">conf</span><span class="o">.</span><span class="n">d</span><span class="o">/*.</span><span class="n">conf</span>
</pre></div>
</div>
<p><strong>项目配置文件示例</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="p">[</span><span class="n">program</span><span class="p">:</span><span class="n">runcode</span><span class="p">]</span>
<span class="n">command</span> <span class="o">=</span><span class="n">python3</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">maintain</span><span class="o">/</span><span class="n">project_ybc</span><span class="o">/</span><span class="n">ybc_baike_rearend</span><span class="o">/</span><span class="n">runcode</span><span class="o">.</span><span class="n">py</span>
<span class="n">autostart</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">autorestart</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">stopwaitsecs</span><span class="o">=</span><span class="mi">1</span>
<span class="n">startsecs</span><span class="o">=</span><span class="mi">1</span>
<span class="n">user</span><span class="o">=</span><span class="n">maintain</span>
<span class="n">stopasgroup</span> <span class="o">=</span> <span class="n">true</span>
<span class="n">stdout_logfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">maintain</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">runcode_out</span><span class="o">.</span><span class="n">log</span>
<span class="n">stderr_logfile</span> <span class="o">=</span> <span class="o">/</span><span class="n">home</span><span class="o">/</span><span class="n">maintain</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">log</span><span class="o">/</span><span class="n">runcode_err</span><span class="o">.</span><span class="n">log</span>
</pre></div>
</div>
<p><strong>启动</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">sudo</span> <span class="n">supervisord</span> <span class="o">-</span><span class="n">c</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">supervisor</span><span class="o">/</span><span class="n">supervisord</span><span class="o">.</span><span class="n">conf</span>
</pre></div>
</div>
<p><strong>进程管理命令</strong></p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">supervisorctl</span> <span class="n">start</span> <span class="nb">all</span> <span class="o">//</span><span class="n">启动所有进程</span>

<span class="n">supervisorctl</span> <span class="n">start</span> <span class="n">配置文件中的进程名</span> <span class="o">//</span><span class="n">启动某一个进程</span>

<span class="n">supervisorctl</span> <span class="n">stop</span> <span class="nb">all</span> <span class="o">//</span><span class="n">停止所有进程</span>

<span class="n">supervisorctl</span> <span class="n">stop</span> <span class="n">配置文件中的进程名</span> <span class="o">//</span><span class="n">停止某一个进程</span>
</pre></div>
</div>
<p><strong>supervisor安装和自启动的一些问题</strong></p>
<p>在supervisor默认配置中，其启动的sock等都会放到tmp目录，而tmp目录会自动清理（比如重启主机）导致无法使用supervisorctl命令；修改supervisor.conf文件，修改到/var/run/及/var/log/目录</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>file=/var/run/supervisor.sock
serverurl=unix:///var/run/supervisor.sock ;等等

*注意：修改supervisor.conf文件后，要执行supervisorctl reload，重新加载配置文件；
*注意：supervisor好像需要root安装；
</pre></div>
</div>
<p><strong>错误：Supervisorctl error: unix:///var/run/supervisord.sock refused connection?</strong></p>
<p>说明需要开启supervisord。</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>echo_supervisord_conf &gt; /etc/supervisord.conf //如果已经修改了supervisor.conf，这句就不要执行了
sudo supervisord -c /etc/supervisord.conf
sudo supervisorctl statu
</pre></div>
</div>
</div>
<div class="section" id="code-mirror">
<h2>Code Mirror代码编辑器插件<a class="headerlink" href="#code-mirror" title="永久链接至标题">¶</a></h2>
<p><strong>1.什么是Code Mirror</strong></p>
<p>Code Mirror支持语法高亮、自动缩进、智能提示等功能，可以在网页上实现一个代码编辑器。</p>
<p><strong>2.使用Code Mirror</strong></p>
<p>下面我将演示如何使用Code Mirror搭建一个简易的代码编辑器，并对其常用配置简要介绍。
首先要到CodeMirror官网下载此插件，然后在网页中引入即可。如下代码即实现了一个可以高亮显示Java代码的编辑器：</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>&lt;!--
最简单的CodeMirror编辑器
--&gt;

&lt;!DOCTYPE
html&gt;

&lt;html&gt;

&lt;!--下面两个是使用Code Mirror必须引入的--&gt;
&lt;link rel=&quot;stylesheet&quot; href=&quot;codemirror-5.12/lib/codemirror.css&quot;&gt;
&lt;script src=&quot;codemirror-5.12/lib/codemirror.js&quot;&gt;&lt;/script&gt;

&lt;!--Java代码高亮必须引入--&gt;
&lt;script src=&quot;codemirror-5.12/clike.js&quot;&gt;&lt;/script&gt;

&lt;head&gt;
&lt;title&gt;CodeMirrorTest&lt;/title&gt;
&lt;/head&gt;
&lt;body&gt;
&lt;textarea id=&quot;code&quot;&gt;&lt;/textarea&gt;
&lt;/body&gt;
&lt;script type=&quot;text/javascript&quot;&gt;
//根据DOM元素的id构造出一个编辑器
    var editor=CodeMirror.fromTextArea(document.getElementById(&quot;code&quot;),{
                mode:&quot;text/x-java&quot; //实现Java代码高亮
        });
&lt;/script&gt;
&lt;/html&gt;
</pre></div>
</div>
<p>如要显示行号，只需在构造editor时加上</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">lineNumbers</span><span class="p">:</span><span class="n">true</span>
</pre></div>
</div>
<p>即</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">var</span> <span class="n">editor</span><span class="o">=</span><span class="n">CodeMirror</span><span class="o">.</span><span class="n">fromTextArea</span><span class="p">(</span><span class="n">document</span><span class="o">.</span><span class="n">getElementById</span><span class="p">(</span><span class="s2">&quot;code&quot;</span><span class="p">),{</span>
            <span class="n">mode</span><span class="p">:</span><span class="s2">&quot;text/x-java&quot;</span><span class="p">,</span> <span class="o">//</span><span class="n">实现Java代码高亮</span>
            <span class="n">lineNumbers</span><span class="p">:</span><span class="n">true</span>
    <span class="p">});</span>
</pre></div>
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="product.html" class="btn btn-neutral float-right" title="产品" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="think.html" class="btn btn-neutral" title="思考" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, wangty.

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.0',
            LANGUAGE:'zh_CN',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true,
            SOURCELINK_SUFFIX: '.txt'
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>
      <script type="text/javascript" src="../_static/language_data.js"></script>
      <script type="text/javascript" src="../_static/translations.js"></script>

  

  <script type="text/javascript" src="../_static/js/theme.js"></script>

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>